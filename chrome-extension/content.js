// chrome extension Content Script

class MCPFeedbackContent {
    constructor() {
        console.log('üöÄ MCP Feedback Content Script: ÂºÄÂßãÂàùÂßãÂåñ...', new Date().toLocaleTimeString());
        this.isActive = false;
        this.feedbackOverlay = null;
        this.screenshotData = null;
        this.selectedFiles = [];
        this.capturedScreenshots = []; // Â≠òÂÇ®Êà™ÂõæÊï∞ÊçÆ
        
        // ÂÖÉÁ¥†Ê£ÄÊü•Áõ∏ÂÖ≥Â±ûÊÄß
        this.isInspecting = false;
        this.inspectOverlay = null;
        this.highlightBox = null;
        this.currentHoveredElement = null;
        this.tooltip = null;
        
        this.initializeListeners();
        this.addStyles();
        console.log('‚úÖ MCP Feedback Content Script: ÂàùÂßãÂåñÂÆåÊàê', new Date().toLocaleTimeString());
    }
    
    initializeListeners() {
        console.log('MCP Feedback Content Script: Initializing listeners');
        
        // ÁõëÂê¨Êù•Ëá™ background Âíå sidepanel ÁöÑÊ∂àÊÅØ
        chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
            console.log('Content script received message:', request);
            try {
                switch (request.action) {
                    case 'startFeedbackCollection':
                        console.log('Starting feedback collection...');
                        this.startFeedbackCollection();
                        sendResponse({ success: true });
                        break;
                        
                    case 'stopFeedbackCollection':
                        console.log('Stopping feedback collection...');
                        this.stopFeedbackCollection();
                        sendResponse({ success: true });
                        break;
                        
                    case 'captureScreenshot':
                        this.captureScreenshot()
                            .then(result => sendResponse(result))
                            .catch(error => {
                                console.error('Screenshot capture failed:', error);
                                sendResponse({ success: false, error: error.message });
                            });
                        return true; // ‰øùÊåÅÊ∂àÊÅØÈÄöÈÅìÂºÄÊîæ
                        
                    case 'getPageInfo':
                        const pageInfo = this.getPageInfo();
                        console.log('Page info:', pageInfo);
                        sendResponse(pageInfo);
                        break;
                        
                    case 'showFeedbackForm':
                        console.log('Showing feedback form...');
                        this.showFeedbackForm(request.data);
                        sendResponse({ success: true });
                        break;
                        
                    case 'startElementInspection':
                        console.log('Starting element inspection...');
                        this.startElementInspection();
                        sendResponse({ success: true });
                        break;
                        
                    case 'stopElementInspection':
                        console.log('Stopping element inspection...');
                        this.stopElementInspection();
                        sendResponse({ success: true });
                        break;
                        
                    case 'startElementCapture':
                        console.log('Content script: startElementCaptureÊ∂àÊÅØÂ∑≤Êî∂Âà∞Ôºå‰ΩÜÁî±element-inspector.jsÂ§ÑÁêÜ');
                        // Ëøô‰∏™Ê∂àÊÅØÁî±element-inspector.jsÂ§ÑÁêÜÔºåcontent.js‰∏çÈúÄË¶ÅÂ§ÑÁêÜ
                        // ‰ΩÜÊàë‰ª¨ÈúÄË¶ÅËøîÂõû‰∏Ä‰∏™ÂìçÂ∫î‰ª•ÈÅøÂÖçÈîôËØØ
                        sendResponse({ success: true, message: 'Message forwarded to element-inspector' });
                        break;
                        
                    case 'stopElementCapture':
                        console.log('Content script: stopElementCaptureÊ∂àÊÅØÂ∑≤Êî∂Âà∞Ôºå‰ΩÜÁî±element-inspector.jsÂ§ÑÁêÜ');
                        sendResponse({ success: true, message: 'Message forwarded to element-inspector' });
                        break;
                        
                    case 'hideFeedbackForm':
                        console.log('Hiding feedback form...');
                        this.hideFeedbackForm();
                        sendResponse({ success: true });
                        break;
                        
                    case 'feedbackConfirmed':
                        console.log('Êî∂Âà∞MCPÊúçÂä°Âô®Á°ÆËÆ§ÔºåÈáçÊñ∞ÂêØÁî®ÂèçÈ¶àË°®Âçï');
                        this.enableFeedbackForm();
                        this.showMessage('ÂèçÈ¶àÊèê‰∫§ÊàêÂäüÔºÅË°®ÂçïÂ∑≤ÈáçÊñ∞ÂêØÁî®', 'success');
                        sendResponse({ success: true });
                        break;
                        
                    case 'connectionStatusChanged':
                        console.log('MCPËøûÊé•Áä∂ÊÄÅÂèòÂåñ:', request.isConnected);
                        if (request.isConnected) {
                            this.enableFeedbackForm();
                            this.showMessage('MCPÊúçÂä°Âô®Â∑≤ËøûÊé•', 'success');
                        } else {
                            this.setFormDisabledState('MCPÊúçÂä°Âô®ËøûÊé•Êñ≠ÂºÄ');
                            this.showMessage('MCPÊúçÂä°Âô®ËøûÊé•Êñ≠ÂºÄ', 'warning');
                        }
                        sendResponse({ success: true });
                        break;

                    case 'automation':
                        console.log('Êî∂Âà∞Ëá™Âä®ÂåñÂëΩ‰ª§:', request);
                        this.handleAutomationCommand(request)
                            .then(result => sendResponse(result))
                            .catch(error => {
                                console.error('Ëá™Âä®ÂåñÂëΩ‰ª§ÊâßË°åÂ§±Ë¥•:', error);
                                sendResponse({ success: false, error: error.message });
                            });
                        return true; // ‰øùÊåÅÊ∂àÊÅØÈÄöÈÅìÂºÄÊîæ

                    default:
                        console.warn('Unknown message action:', request.action);
                        sendResponse({ success: false, error: 'Unknown action' });
                }
            } catch (error) {
                console.error('Error handling message:', error);
                sendResponse({ success: false, error: error.message });
            }
        });
        
        // ÁõëÂê¨ÈîÆÁõò‰∫ã‰ª∂
        document.addEventListener('keydown', this.handleKeyDown.bind(this));
        console.log('MCP Feedback Content Script: Listeners initialized successfully');
    }
    
    addStyles() {
        if (document.getElementById('mcp-feedback-styles')) return;
        
        const style = document.createElement('style');
        style.id = 'mcp-feedback-styles';
        style.textContent = `
            .mcp-feedback-overlay {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: rgba(0, 0, 0, 0.5) !important;
                z-index: 999999 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                font-family: 'Segoe UI', system-ui, sans-serif !important;
            }
            
            .mcp-feedback-form {
                background: white !important;
                border-radius: 12px !important;
                padding: 24px !important;
                max-width: 500px !important;
                width: 90% !important;
                max-height: 80vh !important;
                overflow-y: auto !important;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important;
                position: relative !important;
            }
            
            .mcp-feedback-header {
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                margin-bottom: 20px !important;
                padding-bottom: 16px !important;
                border-bottom: 1px solid #e0e0e0 !important;
            }
            
            .mcp-feedback-title {
                font-size: 20px !important;
                font-weight: 600 !important;
                color: #333 !important;
                margin: 0 !important;
            }
            
            .mcp-feedback-close {
                background: none !important;
                border: none !important;
                font-size: 24px !important;
                cursor: pointer !important;
                color: #666 !important;
                padding: 4px !important;
                border-radius: 4px !important;
                transition: background-color 0.2s !important;
            }
            
            .mcp-feedback-close:hover {
                background-color: #f0f0f0 !important;
            }
            
            .mcp-feedback-section {
                margin-bottom: 20px !important;
            }
            
            .mcp-feedback-label {
                display: block !important;
                font-weight: 500 !important;
                color: #333 !important;
                margin-bottom: 8px !important;
                font-size: 14px !important;
            }
            
            .mcp-feedback-textarea {
                width: 100% !important;
                min-height: 120px !important;
                padding: 12px !important;
                border: 2px solid #e0e0e0 !important;
                border-radius: 8px !important;
                font-family: inherit !important;
                font-size: 14px !important;
                resize: vertical !important;
                transition: border-color 0.2s !important;
                box-sizing: border-box !important;
            }
            
            .mcp-feedback-textarea:focus {
                outline: none !important;
                border-color: #007bff !important;
            }
            
            .mcp-feedback-file-input {
                display: none !important;
            }
            
            .mcp-feedback-drop-zone {
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                width: 100% !important;
                height: 120px !important;
                background: #f8f9fa !important;
                border: 2px dashed #dee2e6 !important;
                border-radius: 8px !important;
                cursor: pointer !important;
                transition: all 0.2s !important;
                margin-bottom: 12px !important;
                position: relative !important;
                overflow: hidden !important;
            }
            
            .mcp-feedback-drop-zone:hover {
                background: #e9ecef !important;
                border-color: #adb5bd !important;
            }
            
            .mcp-feedback-drop-zone.active {
                background: #e8f4ff !important;
                border-color: #007bff !important;
            }
            
            .mcp-feedback-drop-content {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                text-align: center !important;
                padding: 16px !important;
            }
            
            .mcp-feedback-drop-icon {
                font-size: 32px !important;
                margin-bottom: 8px !important;
                color: #6c757d !important;
            }
            
            .mcp-feedback-drop-text {
                font-size: 16px !important;
                font-weight: 500 !important;
                color: #495057 !important;
                margin-bottom: 4px !important;
            }
            
            .mcp-feedback-drop-hint {
                font-size: 12px !important;
                color: #6c757d !important;
            }
            
            .mcp-feedback-preview {
                margin-top: 12px !important;
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 8px !important;
            }
            
            .mcp-feedback-preview-item {
                position: relative !important;
                display: inline-block !important;
            }
            
            .mcp-feedback-preview-image {
                width: 80px !important;
                height: 80px !important;
                object-fit: cover !important;
                border-radius: 6px !important;
                border: 1px solid #dee2e6 !important;
            }
            
            .mcp-feedback-preview-remove {
                position: absolute !important;
                top: -6px !important;
                right: -6px !important;
                width: 20px !important;
                height: 20px !important;
                background: #dc3545 !important;
                color: white !important;
                border: none !important;
                border-radius: 50% !important;
                cursor: pointer !important;
                font-size: 12px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }
            
            .mcp-feedback-buttons {
                display: flex !important;
                gap: 12px !important;
                justify-content: flex-end !important;
                margin-top: 24px !important;
                padding-top: 16px !important;
                border-top: 1px solid #e0e0e0 !important;
            }
            
            .mcp-feedback-button {
                padding: 10px 20px !important;
                border: none !important;
                border-radius: 6px !important;
                font-size: 14px !important;
                font-weight: 500 !important;
                cursor: pointer !important;
                transition: all 0.2s !important;
            }
            
            .mcp-feedback-button-primary {
                background: #007bff !important;
                color: white !important;
            }
            
            .mcp-feedback-button-primary:hover {
                background: #0056b3 !important;
            }
            
            .mcp-feedback-button-secondary {
                background: #6c757d !important;
                color: white !important;
            }
            
            .mcp-feedback-button-secondary:hover {
                background: #545b62 !important;
            }
            
            .mcp-feedback-message {
                position: fixed !important;
                top: 20px !important;
                right: 20px !important;
                padding: 12px 20px !important;
                border-radius: 8px !important;
                font-family: 'Segoe UI', system-ui, sans-serif !important;
                font-size: 14px !important;
                font-weight: 500 !important;
                z-index: 1000000 !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
                animation: slideIn 0.3s ease-out !important;
            }
            
            .mcp-feedback-message-success {
                background: #28a745 !important;
                color: white !important;
            }
            
            .mcp-feedback-message-error {
                background: #dc3545 !important;
                color: white !important;
            }
            
            @keyframes slideIn {
                from {
                    transform: translateX(100%) !important;
                    opacity: 0 !important;
                }
                to {
                    transform: translateX(0) !important;
                    opacity: 1 !important;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0) !important;
                    opacity: 1 !important;
                }
                to {
                    transform: translateX(100%) !important;
                    opacity: 0 !important;
                }
            }
        `;
        
        document.head.appendChild(style);
    }
    
    startFeedbackCollection() {
        console.log('Starting feedback collection');
        this.isActive = true;
        this.showMessage('ÂèçÈ¶àÊî∂ÈõÜÂ∑≤ÂêØÂä®ÔºåÊåâ F2 ÊâìÂºÄÂèçÈ¶àË°®Âçï', 'success');
    }
    
    stopFeedbackCollection() {
        console.log('Stopping feedback collection');
        this.isActive = false;
        this.hideFeedbackForm();
        this.showMessage('ÂèçÈ¶àÊî∂ÈõÜÂ∑≤ÂÅúÊ≠¢', 'success');
    }
    
    // ÂºÄÂßãÂÖÉÁ¥†Ê£ÄÊü•
    startElementInspection() {
        if (this.isInspecting) {
            console.log('‚ö†Ô∏è ÂÖÉÁ¥†Ê£ÄÊü•Â∑≤Âú®ËøõË°å‰∏≠ÔºåË∑≥ËøáÈáçÂ§çÂêØÂä®');
            return;
        }
        
        console.log('üéØ ÂºÄÂßãÂÖÉÁ¥†Ê£ÄÊü•...', new Date().toLocaleTimeString());
        this.isInspecting = true;
        
        // ÂàõÂª∫Ê£ÄÊü•Ë¶ÜÁõñÂ±Ç
        this.createInspectionOverlay();
        
        // ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®
        this.bindInspectionEvents();
        
        // ÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
        this.showInspectionHint();
        
        console.log('‚úÖ ÂÖÉÁ¥†Ê£ÄÊü•Ê®°ÂºèÂ∑≤ÂêØÂä®');
    }
    
    // ÂÅúÊ≠¢ÂÖÉÁ¥†Ê£ÄÊü•
    stopElementInspection(reason = 'programmatic') {
        if (!this.isInspecting) return;
        
        console.log('ÂÅúÊ≠¢ÂÖÉÁ¥†Ê£ÄÊü•ÔºåÂéüÂõ†:', reason);
        this.isInspecting = false;
        
        // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨Âô®
        this.unbindInspectionEvents();
        
        // Ê∏ÖÁêÜË¶ÜÁõñÂ±ÇÂíåÈ´ò‰∫Æ
        this.cleanupInspection();
        
        // ÈÄöÁü•ËÉåÊôØËÑöÊú¨
        console.log('üì§ Content: ÂèëÈÄÅelementInspectionStoppedÊ∂àÊÅØÔºåÂéüÂõ†:', reason);
        chrome.runtime.sendMessage({
            action: 'elementInspectionStopped',
            reason: reason
        }, (response) => {
            if (chrome.runtime.lastError) {
                console.error('‚ùå Content: ÂèëÈÄÅÂÅúÊ≠¢Ê∂àÊÅØÂ§±Ë¥•:', chrome.runtime.lastError);
            } else {
                console.log('‚úÖ Content: ÂÅúÊ≠¢Ê∂àÊÅØÂèëÈÄÅÊàêÂäü:', response);
            }
        });
    }
    
    // ÂàõÂª∫Ê£ÄÊü•Ë¶ÜÁõñÂ±Ç
    createInspectionOverlay() {
        if (this.inspectOverlay) return;
        
        // ÂàõÂª∫ÂçäÈÄèÊòéË¶ÜÁõñÂ±Ç
        this.inspectOverlay = document.createElement('div');
        this.inspectOverlay.id = 'mcp-inspect-overlay';
        this.inspectOverlay.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.1) !important;
            z-index: 999998 !important;
            pointer-events: none !important;
            cursor: crosshair !important;
        `;
        
        // ÂàõÂª∫È´ò‰∫ÆÊ°Ü
        this.highlightBox = document.createElement('div');
        this.highlightBox.id = 'mcp-highlight-box';
        this.highlightBox.style.cssText = `
            position: absolute !important;
            border: 2px solid #007bff !important;
            background: rgba(0, 123, 255, 0.1) !important;
            pointer-events: none !important;
            z-index: 999999 !important;
            display: none !important;
            box-sizing: border-box !important;
        `;
        
        // ÂàõÂª∫Â∑•ÂÖ∑ÊèêÁ§∫
        this.tooltip = document.createElement('div');
        this.tooltip.id = 'mcp-inspect-tooltip';
        this.tooltip.style.cssText = `
            position: absolute !important;
            background: #333 !important;
            color: white !important;
            padding: 8px 12px !important;
            border-radius: 4px !important;
            font-family: 'Segoe UI', Arial, sans-serif !important;
            font-size: 12px !important;
            line-height: 1.4 !important;
            z-index: 1000000 !important;
            display: none !important;
            max-width: 300px !important;
            word-wrap: break-word !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
        `;
        
        // Ê∑ªÂä†Âà∞È°µÈù¢
        document.body.appendChild(this.inspectOverlay);
        document.body.appendChild(this.highlightBox);
        document.body.appendChild(this.tooltip);
    }
    
    // ÁªëÂÆöÊ£ÄÊü•‰∫ã‰ª∂
    bindInspectionEvents() {
        this.onMouseMove = this.handleInspectionMouseMove.bind(this);
        this.onMouseClick = this.handleInspectionClick.bind(this);
        this.onKeyDown = this.handleInspectionKeyDown.bind(this);
        
        // Âú®Â§ö‰∏™Â±ÇÁ∫ßÁªëÂÆö‰∫ã‰ª∂ÔºåÁ°Æ‰øùËÉΩÊçïËé∑
        document.addEventListener('mousemove', this.onMouseMove, true);
        document.addEventListener('click', this.onMouseClick, true);
        document.addEventListener('keydown', this.onKeyDown, true);
        
        // Âú®window‰∏ä‰πüÁªëÂÆöÈîÆÁõò‰∫ã‰ª∂
        window.addEventListener('keydown', this.onKeyDown, true);
        
        // Âú®document.body‰∏ä‰πüÁªëÂÆöÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
        if (document.body) {
            document.body.addEventListener('keydown', this.onKeyDown, true);
        }
        
        console.log('üîó ÂÖÉÁ¥†Ê£ÄÊü•‰∫ã‰ª∂Â∑≤ÁªëÂÆöÂú®Â§ö‰∏™Â±ÇÁ∫ß');
    }
    
    // Ëß£ÁªëÊ£ÄÊü•‰∫ã‰ª∂
    unbindInspectionEvents() {
        if (this.onMouseMove) {
            document.removeEventListener('mousemove', this.onMouseMove, true);
        }
        if (this.onMouseClick) {
            document.removeEventListener('click', this.onMouseClick, true);
        }
        if (this.onKeyDown) {
            document.removeEventListener('keydown', this.onKeyDown, true);
            window.removeEventListener('keydown', this.onKeyDown, true);
            if (document.body) {
                document.body.removeEventListener('keydown', this.onKeyDown, true);
            }
        }
        console.log('üîì ÂÖÉÁ¥†Ê£ÄÊü•‰∫ã‰ª∂Â∑≤‰ªéÊâÄÊúâÂ±ÇÁ∫ßËß£Áªë');
    }
    
    // ÁªëÂÆöÂ∑•ÂÖ∑Ê†èÊúüÈó¥ÁöÑÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨Ôºà‰∏ìÈó®Áî®‰∫éESCÈîÆÔºâ
    bindToolbarKeyListener() {
        this.onToolbarKeyDown = this.handleToolbarKeyDown.bind(this);
        
        // Âú®Â§ö‰∏™Â±ÇÁ∫ßÁªëÂÆöÈîÆÁõò‰∫ã‰ª∂ÔºåÁ°Æ‰øùËÉΩÊçïËé∑ESCÈîÆ
        document.addEventListener('keydown', this.onToolbarKeyDown, true);
        window.addEventListener('keydown', this.onToolbarKeyDown, true);
        
        if (document.body) {
            document.body.addEventListener('keydown', this.onToolbarKeyDown, true);
        }
        
        console.log('üîó Â∑•ÂÖ∑Ê†èESCÈîÆÁõëÂê¨Â∑≤ÁªëÂÆö');
    }
    
    // Ëß£ÁªëÂ∑•ÂÖ∑Ê†èÊúüÈó¥ÁöÑÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨
    unbindToolbarKeyListener() {
        if (this.onToolbarKeyDown) {
            document.removeEventListener('keydown', this.onToolbarKeyDown, true);
            window.removeEventListener('keydown', this.onToolbarKeyDown, true);
            
            if (document.body) {
                document.body.removeEventListener('keydown', this.onToolbarKeyDown, true);
            }
            
            this.onToolbarKeyDown = null;
            console.log('üîì Â∑•ÂÖ∑Ê†èESCÈîÆÁõëÂê¨Â∑≤Ëß£Áªë');
        }
    }
    
    // Â§ÑÁêÜÂ∑•ÂÖ∑Ê†èÊúüÈó¥ÁöÑÈîÆÁõò‰∫ã‰ª∂
    handleToolbarKeyDown(event) {
        console.log('üéπ Â∑•ÂÖ∑Ê†èÈîÆÁõò‰∫ã‰ª∂Ëß¶Âèë:', {
            key: event.key,
            code: event.code,
            keyCode: event.keyCode,
            which: event.which
        });
        
        // Ê£ÄÊü•Â§öÁßçESCÈîÆÁöÑË°®Á§∫ÊñπÂºè
        const isEscapeKey = (
            event.key === 'Escape' || 
            event.code === 'Escape' ||
            event.keyCode === 27 ||
            event.which === 27
        );
        
        if (isEscapeKey) {
            console.log('üèÉ Â∑•ÂÖ∑Ê†èÊúüÈó¥ESCÈîÆË¢´Êåâ‰∏ãÔºåÈÄÄÂá∫ÊçïËé∑ÊµÅÁ®ã');
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            this.showDebugMessage('ESCÈÄÄÂá∫ÊçïËé∑ÊµÅÁ®ã');
            
            // ÊâßË°åÂèñÊ∂àÊçïËé∑Êìç‰Ωú
            this.cancelCapture();
        }
    }
    
    // Â§ÑÁêÜÈº†Ê†áÁßªÂä®
    handleInspectionMouseMove(event) {
        if (!this.isInspecting) return;
        
        event.preventDefault();
        event.stopPropagation();
        
        const element = document.elementFromPoint(event.clientX, event.clientY);
        if (!element || element === this.inspectOverlay || element === this.highlightBox || element === this.tooltip) {
            return;
        }
        
        // Âè™Âú®ÂÖÉÁ¥†ÂèòÂåñÊó∂ËæìÂá∫Êó•ÂøóÔºåÈÅøÂÖçËøáÂ§öÊó•Âøó
        if (this.currentHoveredElement !== element) {
            console.log('üéØ ÊÇ¨ÂÅúÊñ∞ÂÖÉÁ¥†:', element.tagName, element.className, element.id);
        }
        
        this.currentHoveredElement = element;
        this.updateHighlight(element);
        this.updateTooltip(element, event.clientX, event.clientY);
    }
    
    // Â§ÑÁêÜÁÇπÂáª‰∫ã‰ª∂
    handleInspectionClick(event) {
        if (!this.isInspecting) {
            console.log('‚ö†Ô∏è ‰∏çÂú®Ê£ÄÊü•Ê®°Âºè‰∏≠ÔºåÂøΩÁï•ÁÇπÂáª');
            return;
        }
        
        console.log('üñ±Ô∏è ÂÖÉÁ¥†Ê£ÄÊü•ÁÇπÂáª‰∫ã‰ª∂Ëß¶Âèë', event);
        this.showDebugMessage('ÁÇπÂáª‰∫ã‰ª∂Ëß¶ÂèëÔºåÊòæÁ§∫Êà™ÂõæÂ∑•ÂÖ∑Ê†è...');
        
        event.preventDefault();
        event.stopPropagation();
        
        const element = this.currentHoveredElement;
        if (!element) {
            console.log('‚ùå Ê≤°ÊúâÊÇ¨ÂÅúÁöÑÂÖÉÁ¥†ÔºåÊó†Ê≥ïÊçïËé∑');
            this.showDebugMessage('‚ùå Ê≤°ÊúâÊÇ¨ÂÅúÁöÑÂÖÉÁ¥†ÔºåÊó†Ê≥ïÊçïËé∑');
            return;
        }
        
        console.log('üéØ ÁÇπÂáªÁöÑÂÖÉÁ¥†:', element.tagName, element.className, element.id);
        this.showDebugMessage(`ÈÄâ‰∏≠ÂÖÉÁ¥†: ${element.tagName} ${element.className} ${element.id}`);
        
        // ‰øùÂ≠òÂΩìÂâçÈÄâ‰∏≠ÁöÑÂÖÉÁ¥†
        this.selectedElement = element;
        
        // ÂÅúÊ≠¢Ê£ÄÊü•Ê®°Âºè‰ΩÜ‰øùÊåÅÂÖÉÁ¥†È´ò‰∫Æ
        this.unbindInspectionEvents();
        this.isInspecting = false;
        
        // ÊòæÁ§∫Êà™ÂõæÂ∑•ÂÖ∑Ê†è
        this.showCaptureToolbar(element);
    }
    
    // Â§ÑÁêÜÈîÆÁõò‰∫ã‰ª∂
    handleInspectionKeyDown(event) {
        console.log('üéπ ÈîÆÁõò‰∫ã‰ª∂Ëß¶Âèë:', {
            isInspecting: this.isInspecting,
            key: event.key,
            code: event.code,
            keyCode: event.keyCode,
            which: event.which
        });
        
        if (!this.isInspecting) {
            console.log('‚ö†Ô∏è ‰∏çÂú®Ê£ÄÊü•Ê®°ÂºèÔºåÂøΩÁï•ÈîÆÁõò‰∫ã‰ª∂');
            return;
        }
        
        // Ê£ÄÊü•Â§öÁßçESCÈîÆÁöÑË°®Á§∫ÊñπÂºè
        const isEscapeKey = (
            event.key === 'Escape' || 
            event.code === 'Escape' ||
            event.keyCode === 27 ||
            event.which === 27
        );
        
        if (isEscapeKey) {
            console.log('üèÉ ESCÈîÆË¢´Êåâ‰∏ãÔºåÈÄÄÂá∫Ê£ÄÊü•Ê®°Âºè');
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            this.showDebugMessage('ESCÈÄÄÂá∫Ê£ÄÊü•Ê®°Âºè');
            this.stopElementInspection('userEscaped');
        }
    }
    
    // Êõ¥Êñ∞È´ò‰∫Æ
    updateHighlight(element) {
        if (!this.highlightBox) return;
        
        const rect = element.getBoundingClientRect();
        const scrollX = window.scrollX || window.pageXOffset;
        const scrollY = window.scrollY || window.pageYOffset;
        
        this.highlightBox.style.display = 'block';
        this.highlightBox.style.left = (rect.left + scrollX) + 'px';
        this.highlightBox.style.top = (rect.top + scrollY) + 'px';
        this.highlightBox.style.width = rect.width + 'px';
        this.highlightBox.style.height = rect.height + 'px';
    }
    
    // Êõ¥Êñ∞Â∑•ÂÖ∑ÊèêÁ§∫
    updateTooltip(element, mouseX, mouseY) {
        if (!this.tooltip) return;
        
        const tagName = element.tagName.toLowerCase();
        const id = element.id ? `#${element.id}` : '';
        const classes = element.className ? `.${element.className.toString().trim().replace(/\s+/g, '.')}` : '';
        const text = element.textContent ? element.textContent.trim().substring(0, 50) : '';
        
        const tooltipContent = `
            <div><strong>${tagName}${id}${classes}</strong></div>
            ${text ? `<div>ÊñáÊú¨: ${text}${text.length > 50 ? '...' : ''}</div>` : ''}
            <div style="margin-top: 4px; font-size: 11px; opacity: 0.8;">
                ‰ΩçÁΩÆ: ${Math.round(element.getBoundingClientRect().left)}, ${Math.round(element.getBoundingClientRect().top)} | 
                Â§ßÂ∞è: ${Math.round(element.getBoundingClientRect().width)} √ó ${Math.round(element.getBoundingClientRect().height)}
            </div>
        `;
        
        this.tooltip.innerHTML = tooltipContent;
        this.tooltip.style.display = 'block';
        
        // ËÆ°ÁÆóÂ∑•ÂÖ∑ÊèêÁ§∫‰ΩçÁΩÆ
        const tooltipRect = this.tooltip.getBoundingClientRect();
        let left = mouseX + 10;
        let top = mouseY - tooltipRect.height - 10;
        
        // Á°Æ‰øùÂ∑•ÂÖ∑ÊèêÁ§∫‰∏çË∂ÖÂá∫ËßÜÁ™ó
        if (left + tooltipRect.width > window.innerWidth) {
            left = mouseX - tooltipRect.width - 10;
        }
        if (top < 0) {
            top = mouseY + 10;
        }
        
        this.tooltip.style.left = left + 'px';
        this.tooltip.style.top = top + 'px';
    }
    
    // ÊçïËé∑ÂÖÉÁ¥†Êï∞ÊçÆ
    async captureElementData(element) {
        console.log('ÂºÄÂßãÊçïËé∑ÂÖÉÁ¥†Êï∞ÊçÆ:', element.tagName, element.className, element.id);
        this.showDebugMessage('Ê≠£Âú®Êî∂ÈõÜÂÖÉÁ¥†‰ø°ÊÅØ...');
        
        const rect = element.getBoundingClientRect();
        const scrollX = window.scrollX || window.pageXOffset;
        const scrollY = window.scrollY || window.pageYOffset;
        
        // Êî∂ÈõÜÂÖÉÁ¥†Â±ûÊÄß
        const attributes = {};
        for (let attr of element.attributes) {
            attributes[attr.name] = attr.value;
        }
        
        // ÁîüÊàêCSSÈÄâÊã©Âô®
        const cssSelector = this.generateCSSSelector(element);
        
        const elementData = {
            tagName: element.tagName,
            id: element.id || null,
            className: element.className || null,
            textContent: element.textContent ? element.textContent.trim() : null,
            attributes: attributes,
            cssSelector: cssSelector,
            rect: {
                x: rect.left + scrollX,
                y: rect.top + scrollY,
                width: rect.width,
                height: rect.height,
                left: rect.left,
                top: rect.top,
                right: rect.right,
                bottom: rect.bottom
            },
            url: window.location.href,
            timestamp: new Date().toISOString()
        };
        
        console.log('ÂÖÉÁ¥†Âü∫Êú¨‰ø°ÊÅØÂ∑≤Êî∂ÈõÜ');
        
        // Â∞ùËØïÊçïËé∑ÂÖÉÁ¥†Êà™Âõæ
        try {
            console.log('ÂºÄÂßãÊçïËé∑ÂÖÉÁ¥†Êà™Âõæ...');
            this.showDebugMessage('Ê≠£Âú®ÊçïËé∑ÂÖÉÁ¥†Êà™Âõæ...');
            const screenshot = await this.captureElementScreenshot(element);
            if (screenshot) {
                console.log('Êà™ÂõæÊçïËé∑ÊàêÂäüÔºåÊï∞ÊçÆÈïøÂ∫¶:', screenshot.length);
                this.showDebugMessage(`Êà™ÂõæÊàêÂäü! Â§ßÂ∞è:${screenshot.length}`);
                elementData.screenshot = screenshot;
                
                // ‰øùÂ≠òÊà™ÂõæÂà∞ÂÆû‰æãÂèòÈáèÔºåÁî®‰∫éËá™Âä®Ê∑ªÂä†Âà∞ÂèçÈ¶àË°®Âçï
                this.capturedScreenshots.push({
                    data: screenshot,
                    elementInfo: `${element.tagName.toLowerCase()}${element.id ? '#' + element.id : ''}${element.className ? '.' + element.className.split(' ')[0] : ''}`,
                    timestamp: new Date().toISOString()
                });
                console.log('Êà™ÂõæÂ∑≤‰øùÂ≠òÂà∞ capturedScreenshotsÔºåÊÄªÊï∞:', this.capturedScreenshots.length);
            } else {
                console.error('Êà™ÂõæÊçïËé∑Â§±Ë¥•ÔºöËøîÂõû‰∏∫Á©∫');
                this.showDebugMessage('Êà™ÂõæÂ§±Ë¥•ÔºöËøîÂõû‰∏∫Á©∫');
            }
        } catch (error) {
            console.error('ÊçïËé∑ÂÖÉÁ¥†Êà™ÂõæÊó∂ÂèëÁîüÈîôËØØ:', error);
            this.showDebugMessage(`Êà™ÂõæÂºÇÂ∏∏: ${error.message}`);
        }
        
        // ÂèëÈÄÅÊï∞ÊçÆÂà∞ËÉåÊôØËÑöÊú¨
        console.log('ÂèëÈÄÅÂÖÉÁ¥†Êï∞ÊçÆÂà∞ËÉåÊôØËÑöÊú¨...');
        this.showDebugMessage('ÂèëÈÄÅÊï∞ÊçÆÂà∞‰æßËæπÊ†è...');
        chrome.runtime.sendMessage({
            action: 'elementCaptured',
            data: elementData
        }, (response) => {
            if (chrome.runtime.lastError) {
                console.error('ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:', chrome.runtime.lastError);
                this.showDebugMessage(`ÂèëÈÄÅÂ§±Ë¥•: ${chrome.runtime.lastError.message}`);
            } else {
                console.log('Ê∂àÊÅØÂèëÈÄÅÊàêÂäü:', response);
                this.showDebugMessage('Êï∞ÊçÆÂèëÈÄÅÊàêÂäü!');
            }
        });
    }
    
    // ÁîüÊàêCSSÈÄâÊã©Âô®
    generateCSSSelector(element) {
        if (element.id) {
            return `#${element.id}`;
        }
        
        let selector = element.tagName.toLowerCase();
        
        if (element.className) {
            const classes = element.className.toString().trim().split(/\s+/);
            selector += '.' + classes.join('.');
        }
        
        // Â¶ÇÊûúÈÄâÊã©Âô®‰∏çÂîØ‰∏ÄÔºåÊ∑ªÂä†Áà∂Á∫ßË∑ØÂæÑ
        if (document.querySelectorAll(selector).length > 1) {
            let parent = element.parentElement;
            let path = [selector];
            
            while (parent && parent !== document.body && path.length < 5) {
                let parentSelector = parent.tagName.toLowerCase();
                if (parent.id) {
                    parentSelector += `#${parent.id}`;
                    path.unshift(parentSelector);
                    break;
                } else if (parent.className) {
                    const classes = parent.className.toString().trim().split(/\s+/);
                    parentSelector += '.' + classes[0]; // Âè™‰ΩøÁî®Á¨¨‰∏Ä‰∏™Á±ªÂêç
                }
                path.unshift(parentSelector);
                parent = parent.parentElement;
            }
            
            selector = path.join(' > ');
        }
        
        return selector;
    }
    
    // ÊçïËé∑ÂÖÉÁ¥†Êà™ÂõæÔºàÊîπËøõÁâàÔºâ
    async captureElementScreenshot(element) {
        try {
            console.log('ÂºÄÂßãÊçïËé∑ÂÖÉÁ¥†Êà™Âõæ...');
            
            if (element) {
                // Â¶ÇÊûúÂÖÉÁ¥†‰∏çÂú®ËßÜÁ™óÂÜÖÔºåÂÖàÊªöÂä®Âà∞ÂÖÉÁ¥†‰ΩçÁΩÆ
                const rect = element.getBoundingClientRect();
                const isInViewport = (
                    rect.top >= 0 &&
                    rect.left >= 0 &&
                    rect.bottom <= window.innerHeight &&
                    rect.right <= window.innerWidth
                );
                
                if (!isInViewport) {
                    console.log('ÂÖÉÁ¥†‰∏çÂú®ËßÜÁ™óÂÜÖÔºåÊªöÂä®Âà∞ÂÖÉÁ¥†‰ΩçÁΩÆ...');
                    this.showDebugMessage('ÊªöÂä®Âà∞ÂÖÉÁ¥†‰ΩçÁΩÆ...');
                    
                    element.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center',
                        inline: 'center'
                    });
                    
                    // Á≠âÂæÖÊªöÂä®ÂÆåÊàê
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            // ‰ΩøÁî®chrome.tabs APIÊçïËé∑Êï¥‰∏™È°µÈù¢Êà™Âõæ
            return new Promise((resolve) => {
                console.log('ÂèëÈÄÅÊà™ÂõæËØ∑Ê±ÇÂà∞background script...');
                chrome.runtime.sendMessage({
                    action: 'captureElementScreenshot'
                }, (response) => {
                    if (response && response.success && response.screenshot) {
                        console.log('Êà™ÂõæÊàêÂäüÔºåÊï∞ÊçÆÈïøÂ∫¶:', response.screenshot.length);
                        resolve(response.screenshot);
                    } else {
                        console.error('Êà™ÂõæÂ§±Ë¥•ÊàñÊó†Êï∞ÊçÆ:', response?.error || 'Êú™Áü•ÈîôËØØ');
                        resolve(null);
                    }
                });
            });
        } catch (error) {
            console.error('ÊçïËé∑Êà™ÂõæÂºÇÂ∏∏:', error);
            return null;
        }
    }
    
    // ÊòæÁ§∫Ê£ÄÊü•ÊèêÁ§∫
    showInspectionHint() {
        const hint = document.createElement('div');
        hint.id = 'mcp-inspection-hint';
        hint.style.cssText = `
            position: fixed !important;
            top: 20px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            background: #333 !important;
            color: white !important;
            padding: 12px 20px !important;
            border-radius: 6px !important;
            font-family: 'Segoe UI', Arial, sans-serif !important;
            font-size: 14px !important;
            z-index: 1000001 !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
            animation: fadeIn 0.3s ease-out !important;
        `;
        hint.innerHTML = 'üéØ ÁÇπÂáªÈ°µÈù¢ÂÖÉÁ¥†ËøõË°åÊçïËé∑ÔºåÊåâ ESC ÈîÆÈÄÄÂá∫Ê£ÄÊü•Ê®°Âºè';
        
        document.body.appendChild(hint);
        
        // 3ÁßíÂêéËá™Âä®ÁßªÈô§ÊèêÁ§∫
        setTimeout(() => {
            if (hint.parentNode) {
                hint.remove();
            }
        }, 3000);
    }
    
    // ÊòæÁ§∫Ë∞ÉËØïÊ∂àÊÅØ
    showDebugMessage(message) {
        const debugDiv = document.getElementById('mcp-debug-message') || document.createElement('div');
        debugDiv.id = 'mcp-debug-message';
        debugDiv.style.cssText = `
            position: fixed !important;
            top: 60px !important;
            right: 20px !important;
            background: #ff4444 !important;
            color: white !important;
            padding: 10px 15px !important;
            border-radius: 4px !important;
            font-family: monospace !important;
            font-size: 12px !important;
            z-index: 1000002 !important;
            max-width: 300px !important;
            word-wrap: break-word !important;
        `;
        debugDiv.textContent = message;
        
        if (!debugDiv.parentNode) {
            document.body.appendChild(debugDiv);
        }
        
        // 3ÁßíÂêéÁßªÈô§
        setTimeout(() => {
            if (debugDiv.parentNode) {
                debugDiv.remove();
            }
        }, 3000);
    }

    // ÊòæÁ§∫Êà™ÂõæÂ∑•ÂÖ∑Ê†è
    showCaptureToolbar(element) {
        // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÂ∑•ÂÖ∑Ê†è
        this.removeCaptureToolbar();
        
        console.log('üîß ÊòæÁ§∫Êà™ÂõæÂ∑•ÂÖ∑Ê†è');
        this.showDebugMessage('ÊòæÁ§∫Êà™ÂõæÂ∑•ÂÖ∑Ê†è');
        
        // ÁªëÂÆöÂ∑•ÂÖ∑Ê†èÊúüÈó¥ÁöÑESCÈîÆÁõëÂê¨
        this.bindToolbarKeyListener();
        
        // Ëé∑ÂèñÂÖÉÁ¥†‰ΩçÁΩÆ
        const rect = element.getBoundingClientRect();
        const scrollX = window.scrollX || window.pageXOffset;
        const scrollY = window.scrollY || window.pageYOffset;
        
        // ËÆ°ÁÆóÂ∑•ÂÖ∑Ê†èÁöÑÊúÄ‰Ω≥‰ΩçÁΩÆ
        const toolbarWidth = 260; // È¢Ñ‰º∞Â∑•ÂÖ∑Ê†èÂÆΩÂ∫¶
        const toolbarHeight = 40; // È¢Ñ‰º∞Â∑•ÂÖ∑Ê†èÈ´òÂ∫¶
        const gap = 10; // ‰∏éÂÖÉÁ¥†ÁöÑÈó¥Ë∑ù
        
        let left, top;
        
        // ‰ºòÂÖàÂ∞ùËØïÊîæÂú®ÂÖÉÁ¥†Âè≥‰æß
        if (rect.right + gap + toolbarWidth <= window.innerWidth) {
            left = rect.right + gap;
            top = Math.max(10, Math.min(rect.top, window.innerHeight - toolbarHeight - 10));
        }
        // Â¶ÇÊûúÂè≥‰æßÁ©∫Èó¥‰∏çÂ§üÔºåÂ∞ùËØïÂ∑¶‰æß
        else if (rect.left - gap - toolbarWidth >= 0) {
            left = rect.left - gap - toolbarWidth;
            top = Math.max(10, Math.min(rect.top, window.innerHeight - toolbarHeight - 10));
        }
        // Â¶ÇÊûúÂ∑¶Âè≥ÈÉΩ‰∏çÂ§üÔºåÊîæÂú®ÂÖÉÁ¥†‰∏äÊñπÊàñ‰∏ãÊñπ
        else {
            left = Math.max(10, Math.min(rect.left, window.innerWidth - toolbarWidth - 10));
            if (rect.top - gap - toolbarHeight >= 0) {
                top = rect.top - gap - toolbarHeight;
            } else {
                top = rect.bottom + gap;
            }
        }
        
        // ÂàõÂª∫Â∑•ÂÖ∑Ê†èÂÆπÂô®
        const toolbar = document.createElement('div');
        toolbar.id = 'mcp-capture-toolbar';
        toolbar.style.cssText = `
            position: fixed !important;
            top: ${top}px !important;
            left: ${left}px !important;
            background: rgba(243, 243, 243, 0.95) !important;
            color: #333333 !important;
            padding: 0 !important;
            border-radius: 6px !important;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif !important;
            font-size: 14px !important;
            font-weight: 400 !important;
            z-index: 1000003 !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(0, 0, 0, 0.1) !important;
            display: flex !important;
            align-items: center !important;
            gap: 1px !important;
            animation: toolbarFadeIn 0.2s ease-out !important;
            backdrop-filter: blur(12px) !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            min-width: 280px !important;
            height: 36px !important;
        `;
        
        // Ê∑ªÂä†VSCodeÈ£éÊ†ºÁöÑÂä®ÁîªÊ†∑Âºè
        const existingStyle = document.getElementById('mcp-toolbar-styles');
        if (existingStyle) {
            existingStyle.remove();
        }
        
        const style = document.createElement('style');
        style.id = 'mcp-toolbar-styles';
        style.textContent = `
            @keyframes toolbarFadeIn {
                from {
                    transform: scale(0.95);
                    opacity: 0;
                }
                to {
                    transform: scale(1);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
        
        // Win10È£éÊ†ºÁöÑÂ∑•ÂÖ∑Ê†èÂÜÖÂÆπ
        toolbar.innerHTML = `
            <button id="mcp-insert-text" style="
                background: transparent;
                color: #333333;
                border: none;
                border-right: 1px solid rgba(0, 0, 0, 0.1);
                padding: 0 16px;
                cursor: pointer;
                font-size: 14px;
                font-family: inherit;
                font-weight: 400;
                transition: all 0.15s ease;
                display: flex;
                align-items: center;
                gap: 8px;
                white-space: nowrap;
                height: 36px;
                line-height: 1;
                border-radius: 5px 0 0 5px;
                flex: 1;
            ">
                <span style="font-size: 16px; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;">üìÑ</span>
                <span>Ëé∑Âèñ‰ø°ÊÅØ</span>
            </button>
            <button id="mcp-confirm-capture" style="
                background: transparent;
                color: #333333;
                border: none;
                border-right: 1px solid rgba(0, 0, 0, 0.1);
                padding: 0 16px;
                cursor: pointer;
                font-size: 14px;
                font-family: inherit;
                font-weight: 400;
                transition: all 0.15s ease;
                display: flex;
                align-items: center;
                gap: 8px;
                white-space: nowrap;
                height: 36px;
                line-height: 1;
                flex: 1;
            ">
                <span style="font-size: 16px; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;">üì∑</span>
                <span>Êà™Âõæ</span>
            </button>
            <button id="mcp-cancel-capture" style="
                background: transparent;
                color: #333333;
                border: none;
                padding: 0 16px;
                cursor: pointer;
                font-size: 14px;
                font-family: inherit;
                font-weight: 400;
                transition: all 0.15s ease;
                display: flex;
                align-items: center;
                gap: 8px;
                white-space: nowrap;
                height: 36px;
                line-height: 1;
                border-radius: 0 5px 5px 0;
                flex: 1;
            ">
                <span style="font-size: 16px; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;">‚úï</span>
                <span>ÂÖ≥Èó≠</span>
            </button>
        `;
        
        document.body.appendChild(toolbar);
        
        // ÁªëÂÆö‰∫ã‰ª∂
        document.getElementById('mcp-insert-text').addEventListener('click', () => {
            console.log('üîò ÊèíÂÖ•ÊñáÊú¨ÊåâÈíÆË¢´ÁÇπÂáª');
            this.insertTextToElement();
        });
        
        document.getElementById('mcp-confirm-capture').addEventListener('click', () => {
            console.log('üîò Á°ÆËÆ§Êà™ÂõæÊåâÈíÆË¢´ÁÇπÂáª');
            this.confirmCapture();
        });
        
        document.getElementById('mcp-cancel-capture').addEventListener('click', () => {
            console.log('üîò ÂèñÊ∂àÊåâÈíÆË¢´ÁÇπÂáª');
            this.cancelCapture();
        });
        
        const buttons = toolbar.querySelectorAll('button');
        buttons.forEach(btn => {
            btn.addEventListener('mouseenter', (e) => {
                e.target.style.background = 'rgba(0, 0, 0, 0.04)';
                e.target.style.color = '#333333';
                e.target.style.transform = 'translateY(-1px)';
                e.target.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
            });
            
            btn.addEventListener('mouseleave', (e) => {
                e.target.style.background = 'transparent';
                e.target.style.color = '#333333';
                e.target.style.transform = 'translateY(0)';
                e.target.style.boxShadow = 'none';
            });
            
            btn.addEventListener('mousedown', (e) => {
                e.target.style.background = 'rgba(0, 0, 0, 0.08)';
                e.target.style.transform = 'translateY(0) scale(0.98)';
                e.target.style.transition = 'all 0.1s ease';
            });
            
            btn.addEventListener('mouseup', (e) => {
                e.target.style.background = 'rgba(0, 0, 0, 0.04)';
                e.target.style.transform = 'translateY(-1px) scale(1)';
                e.target.style.transition = 'all 0.15s ease';
            });
            
            // Ê∑ªÂä†Win10È£éÊ†ºÁöÑÁÑ¶ÁÇπÊ†∑Âºè
            btn.addEventListener('focus', (e) => {
                e.target.style.outline = '2px solid #0078d4';
                e.target.style.outlineOffset = '1px';
            });
            
            btn.addEventListener('blur', (e) => {
                e.target.style.outline = 'none';
            });
        });
    }

    // ÁßªÈô§Êà™ÂõæÂ∑•ÂÖ∑Ê†è
    removeCaptureToolbar() {
        const toolbar = document.getElementById('mcp-capture-toolbar');
        if (toolbar) {
            toolbar.remove();
        }
        
        // Ëß£ÁªëÂ∑•ÂÖ∑Ê†èÊúüÈó¥ÁöÑESCÈîÆÁõëÂê¨
        this.unbindToolbarKeyListener();
    }

    // Á°ÆËÆ§ÊçïËé∑
    async confirmCapture() {
        console.log('Áî®Êà∑Á°ÆËÆ§ÊçïËé∑ÂÖÉÁ¥†');
        this.showDebugMessage('ÂºÄÂßãÊçïËé∑ÂÖÉÁ¥†...');
        
        // ÁßªÈô§Â∑•ÂÖ∑Ê†è
        this.removeCaptureToolbar();
        
        // ÊâßË°åÂÆûÈôÖÁöÑÊçïËé∑Êìç‰Ωú
        if (this.selectedElement) {
            await this.captureElementData(this.selectedElement);
            
            // Á≠âÂæÖÊà™ÂõæÂ§ÑÁêÜÂÆåÊàêÔºåÁÑ∂ÂêéÊòæÁ§∫ÂèçÈ¶àË°®Âçï
            setTimeout(() => {
                console.log('Êà™ÂõæÊçïËé∑ÂÆåÊàêÔºåÊòæÁ§∫ÂèçÈ¶àË°®ÂçïÔºåÂΩìÂâçÊà™ÂõæÊï∞Èáè:', this.capturedScreenshots.length);
                this.showDebugMessage('ÊòæÁ§∫ÂèçÈ¶àË°®Âçï...');
                
                // Á°Æ‰øùselectedFilesÊï∞ÁªÑË¢´ÂàùÂßãÂåñ
                this.selectedFiles = [];
                
                this.showFeedbackForm({
                    prefilledText: '=== ÂÖÉÁ¥†Êà™ÂõæÂ∑≤ÊçïËé∑ ===\nËØ∑Âú®‰∏ãÊñπÊèèËø∞ÊÇ®ÁöÑÈóÆÈ¢òÊàñÂª∫ËÆÆÔºö\n\n'
                });
            }, 500); // Áªô‰∏ÄÁÇπÊó∂Èó¥ËÆ©Êà™ÂõæÂ§ÑÁêÜÂÆåÊàê
        }
        
        // ÂÅúÊ≠¢Ê£ÄÊü•Âπ∂ÈÄöÁü•ÂÆåÊàê
        this.stopElementInspection('captureCompleted');
        
        // Ê∏ÖÁêÜÔºà‰ΩÜ‰∏çÊ∏ÖÁêÜÊà™ÂõæÊï∞ÊçÆÔºåÂõ†‰∏∫Ë¶ÅÁî®Âú®ÂèçÈ¶àË°®Âçï‰∏≠Ôºâ
        this.selectedElement = null;
        this.removeCaptureToolbar();
        this.cleanupInspection();
    }

    // ÂèñÊ∂àÊçïËé∑
    cancelCapture() {
        console.log('üö´ cancelCapture: Áî®Êà∑ÂèñÊ∂àÊçïËé∑ÔºåÂºÄÂßãÁªìÊùüÊ£ÄÊü•ÊµÅÁ®ã');
        this.showDebugMessage('ÁªìÊùüÂÖÉÁ¥†Ê£ÄÊü•');
        
        // ÁßªÈô§Â∑•ÂÖ∑Ê†è
        console.log('üö´ cancelCapture: ÁßªÈô§Â∑•ÂÖ∑Ê†è');
        this.removeCaptureToolbar();
        
        // ÂÆåÂÖ®ÂÅúÊ≠¢Ê£ÄÊü•Ôºà‰∏çÂÜçÈáçÊñ∞ÂºÄÂßãÔºâ
        console.log('üö´ cancelCapture: Ë∞ÉÁî®stopElementInspectionÔºåÂéüÂõ†ÔºöuserCancelled');
        this.stopElementInspection('userCancelled');
        
        // Ê∏ÖÁêÜÁä∂ÊÄÅ
        console.log('üö´ cancelCapture: Ê∏ÖÁêÜÁä∂ÊÄÅ');
        this.cleanupCapture();
        
        console.log('üö´ cancelCapture: ÂèñÊ∂àÊµÅÁ®ãÂÆåÊàê');
    }

    // Ëé∑ÂèñÂÖÉÁ¥†‰ø°ÊÅØÂπ∂Â°´ÂÖÖÂà∞ÂèçÈ¶àÂÜÖÂÆπ
    insertTextToElement() {
        console.log('‚úèÔ∏è Ëé∑ÂèñÂÖÉÁ¥†‰ø°ÊÅØÂπ∂Â°´ÂÖÖÂà∞ÂèçÈ¶à');
        this.showDebugMessage('Ê≠£Âú®Ëé∑ÂèñÂÖÉÁ¥†‰ø°ÊÅØ...');
        
        // ÁßªÈô§Â∑•ÂÖ∑Ê†è
        this.removeCaptureToolbar();
        
        // Ê£ÄÊü•ÈÄâ‰∏≠ÁöÑÂÖÉÁ¥†
        if (!this.selectedElement) {
            this.showMessage('Êú™ÈÄâ‰∏≠ÊúâÊïàÂÖÉÁ¥†', 'error');
            return;
        }
        
        // Ëé∑ÂèñÂÖÉÁ¥†‰ø°ÊÅØÂπ∂Â°´ÂÖÖÂà∞ÂèçÈ¶àË°®Âçï
        this.captureElementInfoAndShowFeedback();
    }

    // Ëé∑ÂèñÂÖÉÁ¥†‰ø°ÊÅØÂπ∂ÊòæÁ§∫ÂèçÈ¶àË°®Âçï
    async captureElementInfoAndShowFeedback() {
        if (!this.selectedElement) {
            this.showMessage('Êú™ÈÄâ‰∏≠ÊúâÊïàÂÖÉÁ¥†', 'error');
            return;
        }
        
        const element = this.selectedElement;
        
        // Êî∂ÈõÜÂÖÉÁ¥†Âü∫Êú¨‰ø°ÊÅØ
        const rect = element.getBoundingClientRect();
        const scrollX = window.scrollX || window.pageXOffset;
        const scrollY = window.scrollY || window.pageYOffset;
        
        // Êî∂ÈõÜÂÖÉÁ¥†Â±ûÊÄß
        const attributes = {};
        for (let attr of element.attributes) {
            attributes[attr.name] = attr.value;
        }
        
        // ÁîüÊàêCSSÈÄâÊã©Âô®
        const cssSelector = this.generateCSSSelector(element);
        
        // ÁîüÊàêÂÖÉÁ¥†‰ø°ÊÅØÊñáÊú¨
        const elementInfo = this.generateElementInfoText(element, cssSelector, rect, attributes);
        
        console.log('ÂÖÉÁ¥†‰ø°ÊÅØÂ∑≤ÁîüÊàê:', elementInfo);
        this.showDebugMessage('ÂÖÉÁ¥†‰ø°ÊÅØÂ∑≤Ëé∑ÂèñÔºåÊòæÁ§∫ÂèçÈ¶àË°®Âçï');
        
        // ÊòæÁ§∫ÂèçÈ¶àË°®ÂçïÔºåÂπ∂È¢ÑÂ°´ÂÖÖÂÖÉÁ¥†‰ø°ÊÅØ
        this.showFeedbackForm({
            prefilledText: elementInfo
        });
        
        // ÂÅúÊ≠¢Ê£ÄÊü•
        this.stopElementInspection('feedbackShown');
        this.cleanupCapture();
    }
    
    // ÁîüÊàêÂÖÉÁ¥†‰ø°ÊÅØÊñáÊú¨
    generateElementInfoText(element, cssSelector, rect, attributes) {
        const tagName = element.tagName.toLowerCase();
        const id = element.id ? `#${element.id}` : '';
        const classes = element.className ? element.className.toString().trim().split(' ').map(c => `.${c}`).join('') : '';
        const text = element.textContent ? element.textContent.trim() : '';
        
        let info = `=== È°µÈù¢ÂÖÉÁ¥†‰ø°ÊÅØ ===\n`;
        info += `È°µÈù¢URL: ${window.location.href}\n`;
        info += `Êó∂Èó¥: ${new Date().toLocaleString()}\n\n`;
        
        info += `=== ÂÖÉÁ¥†Âü∫Êú¨‰ø°ÊÅØ ===\n`;
        info += `Ê†áÁ≠æ: ${tagName}\n`;
        if (id) info += `ID: ${id}\n`;
        if (classes) info += `Á±ªÂêç: ${classes}\n`;
        info += `CSSÈÄâÊã©Âô®: ${cssSelector}\n\n`;
        
        info += `=== ÂÖÉÁ¥†‰ΩçÁΩÆ‰ø°ÊÅØ ===\n`;
        info += `‰ΩçÁΩÆ: (${Math.round(rect.left + window.scrollX)}, ${Math.round(rect.top + window.scrollY)})\n`;
        info += `Â§ßÂ∞è: ${Math.round(rect.width)} √ó ${Math.round(rect.height)}\n`;
        info += `ÂèØËßÜÂå∫Âüü‰ΩçÁΩÆ: (${Math.round(rect.left)}, ${Math.round(rect.top)})\n\n`;
        
        if (text && text.length > 0) {
            info += `=== ÂÖÉÁ¥†ÊñáÊú¨ÂÜÖÂÆπ ===\n`;
            info += `${text.length > 200 ? text.substring(0, 200) + '...' : text}\n\n`;
        }
        
        // Âè™ÊòæÁ§∫ÈáçË¶ÅÁöÑÂ±ûÊÄß
        const importantAttrs = ['src', 'href', 'alt', 'title', 'value', 'placeholder', 'type', 'name'];
        const relevantAttrs = Object.entries(attributes).filter(([key]) => 
            importantAttrs.includes(key) || key.startsWith('data-')
        );
        
        if (relevantAttrs.length > 0) {
            info += `=== ÈáçË¶ÅÂ±ûÊÄß ===\n`;
            relevantAttrs.forEach(([key, value]) => {
                info += `${key}: ${value}\n`;
            });
            info += '\n';
        }
        
        info += `=== Áî®Êà∑ÂèçÈ¶à ===\n`;
        info += `ËØ∑Âú®Ê≠§ÊèèËø∞ÊÇ®ÁöÑÈóÆÈ¢òÊàñÂª∫ËÆÆÔºö\n\n`;
        
        return info;
    }



    // ÂºÄÂßãÁºñËæëÊ®°Âºè
    startEditMode() {
        console.log('‚úèÔ∏è ËøõÂÖ•ÁºñËæëÊ®°Âºè');
        this.showDebugMessage('ÁºñËæëÂäüËÉΩÂºÄÂèë‰∏≠...');
        
        // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÁÆÄÂçïÁöÑÁºñËæëÂäüËÉΩ
        // ÊØîÂ¶ÇÊ∑ªÂä†ÊñáÂ≠ó„ÄÅÁÆ≠Â§¥Á≠â
        alert('ÁºñËæëÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠ÔºåÊï¨ËØ∑ÊúüÂæÖÔºÅ');
    }

    // ÈÄöÁü•‰æßËæπÊ†èÊ£ÄÊü•Â∑≤ÂÅúÊ≠¢ÔºàÂ∑≤Â∫üÂºÉÔºåÁªü‰∏Ä‰ΩøÁî®stopElementInspectionÔºâ
    // notifyInspectionStopped() - Â∑≤ÁßªÈô§ÔºåÂäüËÉΩÂêàÂπ∂Âà∞stopElementInspection

    // ÈÄöÁü•‰æßËæπÊ†èÊ£ÄÊü•Â∑≤ÂÆåÊàêÔºàÂ∑≤Â∫üÂºÉÔºåÁªü‰∏Ä‰ΩøÁî®stopElementInspectionÔºâ  
    // notifyInspectionCompleted() - Â∑≤ÁßªÈô§ÔºåÂäüËÉΩÂêàÂπ∂Âà∞stopElementInspection

    // Ê∏ÖÁêÜÊçïËé∑Áõ∏ÂÖ≥Áä∂ÊÄÅ
    cleanupCapture() {
        this.selectedElement = null;
        this.removeCaptureToolbar();
        this.cleanupInspection();
    }

    // Ê∏ÖÁêÜÊ£ÄÊü•Áõ∏ÂÖ≥ÂÖÉÁ¥†
    cleanupInspection() {
        // ÁßªÈô§Ë¶ÜÁõñÂ±Ç
        if (this.inspectOverlay) {
            this.inspectOverlay.remove();
            this.inspectOverlay = null;
        }
        
        // ÁßªÈô§È´ò‰∫ÆÊ°Ü
        if (this.highlightBox) {
            this.highlightBox.remove();
            this.highlightBox = null;
        }
        
        // ÁßªÈô§Â∑•ÂÖ∑ÊèêÁ§∫
        if (this.tooltip) {
            this.tooltip.remove();
            this.tooltip = null;
        }
        
        // ÁßªÈô§ÊèêÁ§∫‰ø°ÊÅØ
        const hint = document.getElementById('mcp-inspection-hint');
        if (hint) {
            hint.remove();
        }
        
        // ÁßªÈô§Ë∞ÉËØïÊ∂àÊÅØ
        const debugMsg = document.getElementById('mcp-debug-message');
        if (debugMsg) {
            debugMsg.remove();
        }
        
        // ÁßªÈô§Êà™ÂõæÂ∑•ÂÖ∑Ê†è
        this.removeCaptureToolbar();
        
        // ÈáçÁΩÆÁä∂ÊÄÅ
        this.currentHoveredElement = null;
        this.selectedElement = null;
    }
    
    async captureScreenshot() {
        try {
            // ‰ΩøÁî® html2canvas ÊàñÁ±ª‰ººÂ∫ìÊù•ÊçïËé∑È°µÈù¢Êà™Âõæ
            // ËøôÈáåÁÆÄÂåñÂÆûÁé∞ÔºåÂÆûÈôÖÂ∫îËØ•‰ΩøÁî®Êõ¥Â•ΩÁöÑÊà™ÂõæÊñπÊ°à
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // ÁÆÄÂçïÁöÑÈ°µÈù¢‰ø°ÊÅØÊçïËé∑
            const pageInfo = this.getPageInfo();
            
            return {
                success: true,
                screenshot: null, // ÂÆûÈôÖÂÆûÁé∞‰∏≠Â∫îËØ•ËøîÂõûÊà™ÂõæÊï∞ÊçÆ
                pageInfo: pageInfo
            };
        } catch (error) {
            console.error('Screenshot capture failed:', error);
            throw error;
        }
    }
    
    getPageInfo() {
        return {
            url: window.location.href,
            title: document.title,
            timestamp: new Date().toISOString(),
            viewport: {
                width: window.innerWidth,
                height: window.innerHeight
            },
            scroll: {
                x: window.scrollX,
                y: window.scrollY
            }
        };
    }
    
    showFeedbackForm(data = {}) {
        if (this.feedbackOverlay) {
            this.hideFeedbackForm();
        }
        
        const overlay = document.createElement('div');
        overlay.className = 'mcp-feedback-overlay';
        overlay.innerHTML = `
            <div class="mcp-feedback-form">
                <div class="mcp-feedback-header">
                    <h3 class="mcp-feedback-title">üí¨ Êèê‰∫§ÂèçÈ¶à</h3>
                    <button class="mcp-feedback-close" onclick="this.closest('.mcp-feedback-overlay').remove()">&times;</button>
                </div>
                
                <div class="mcp-feedback-section">
                    <label class="mcp-feedback-label">üìù ÊÇ®ÁöÑÂèçÈ¶àÂÜÖÂÆπÔºö</label>
                    <textarea 
                        class="mcp-feedback-textarea" 
                        placeholder="ËØ∑ÊèèËø∞ÊÇ®ÁöÑÈóÆÈ¢ò„ÄÅÂª∫ËÆÆÊàñÊÑèËßÅ..."
                        id="mcp-feedback-text"
                    >${data.prefilledText || ''}</textarea>
                </div>
                
                <div class="mcp-feedback-section">
                    <label class="mcp-feedback-label">üì∑ Ê∑ªÂä†ÂõæÁâáÔºàÂèØÈÄâÔºâÔºö</label>
                    <input 
                        type="file" 
                        class="mcp-feedback-file-input" 
                        id="mcp-feedback-files" 
                        multiple 
                        accept="image/*"
                    >
                    <div class="mcp-feedback-drop-zone" id="mcp-feedback-drop-zone">
                        <div class="mcp-feedback-drop-content">
                            <div class="mcp-feedback-drop-icon">üìÅ</div>
                            <div class="mcp-feedback-drop-text">ÊãñÊãΩÂõæÁâáÂà∞Ê≠§Â§ÑÊàñÁÇπÂáªÈÄâÊã©Êñá‰ª∂</div>
                            <div class="mcp-feedback-drop-hint">ÊîØÊåÅ JPG„ÄÅPNG„ÄÅGIF Ê†ºÂºèÔºåËá™Âä®ÂéãÁº©</div>
                        </div>
                    </div>
                    <div class="mcp-feedback-preview" id="mcp-feedback-preview"></div>
                </div>
                
                <div class="mcp-feedback-buttons">
                    <button class="mcp-feedback-button mcp-feedback-button-secondary" onclick="this.closest('.mcp-feedback-overlay').remove()">
                        ÂèñÊ∂à
                    </button>
                    <button class="mcp-feedback-button mcp-feedback-button-primary" id="mcp-feedback-submit">
                        Êèê‰∫§ÂèçÈ¶à
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        this.feedbackOverlay = overlay;
        
        // ÈáçÁΩÆÊñá‰ª∂ÂàóË°®
        this.selectedFiles = [];
        
        // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        this.setupFeedbackFormListeners();
        
        // ÂàùÂßãÁä∂ÊÄÅ‰∏∫Á¶ÅÁî®ÔºåÁ≠âÂæÖMCPÊúçÂä°Âô®Á°ÆËÆ§
        this.setFormDisabledState('Á≠âÂæÖMCPÊúçÂä°Âô®ËøûÊé•...');
        
        // Ê£ÄÊü•MCPËøûÊé•Áä∂ÊÄÅ
        this.checkMCPConnectionStatus();
        
        // Ëá™Âä®Ê∑ªÂä†ÊçïËé∑ÁöÑÊà™ÂõæÂà∞ÂèçÈ¶àË°®Âçï
        this.autoAddCapturedScreenshots();
        
        // ËÅöÁÑ¶Âà∞ÊñáÊú¨Ê°Ü
        setTimeout(() => {
            const textarea = document.getElementById('mcp-feedback-text');
            if (textarea) textarea.focus();
        }, 100);
    }
    
    // Ëá™Âä®Ê∑ªÂä†ÊçïËé∑ÁöÑÊà™ÂõæÂà∞ÂèçÈ¶àË°®Âçï
    async autoAddCapturedScreenshots() {
        console.log('autoAddCapturedScreenshotsË¢´Ë∞ÉÁî®ÔºåÊà™ÂõæÊï∞Èáè:', this.capturedScreenshots.length);
        
        if (this.capturedScreenshots.length === 0) {
            console.log('Ê≤°ÊúâÊçïËé∑ÁöÑÊà™ÂõæÈúÄË¶ÅÊ∑ªÂä†');
            return;
        }
        
        console.log('ÂºÄÂßãËá™Âä®Ê∑ªÂä†', this.capturedScreenshots.length, 'Âº†Êà™ÂõæÂà∞ÂèçÈ¶àË°®Âçï');
        
        // Á≠âÂæÖDOMÂáÜÂ§áÂ•Ω
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const preview = document.getElementById('mcp-feedback-preview');
        if (!preview) {
            console.error('Êâæ‰∏çÂà∞È¢ÑËßàÂÆπÂô®ÔºåÂ∞ÜÂú®DOMÂáÜÂ§áÂêéÈáçËØï');
            // Âª∂ËøüÈáçËØï
            setTimeout(() => this.autoAddCapturedScreenshots(), 1000);
            return;
        }
        
        console.log('ÊâæÂà∞È¢ÑËßàÂÆπÂô®ÔºåÂºÄÂßãÂ§ÑÁêÜÊà™Âõæ');
        
        // Á°Æ‰øùselectedFilesÊï∞ÁªÑÂ≠òÂú®
        if (!this.selectedFiles) {
            this.selectedFiles = [];
            console.log('ÂàùÂßãÂåñselectedFilesÊï∞ÁªÑ');
        }
        
        let successCount = 0;
        let failCount = 0;
        
        // Â∞ÜÊà™ÂõæËΩ¨Êç¢‰∏∫FileÂØπË±°Âπ∂Ê∑ªÂä†Âà∞selectedFiles
        for (let i = 0; i < this.capturedScreenshots.length; i++) {
            const screenshotInfo = this.capturedScreenshots[i];
            try {
                console.log(`Â§ÑÁêÜÁ¨¨${i+1}Âº†Êà™Âõæ:`, screenshotInfo.elementInfo);
                
                // Â∞Übase64ËΩ¨Êç¢‰∏∫FileÂØπË±°
                const file = await this.base64ToFile(
                    screenshotInfo.data, 
                    `Êà™Âõæ-${screenshotInfo.elementInfo}-${Date.now()}.png`,
                    'image/png'
                );
                
                this.selectedFiles.push(file);
                successCount++;
                console.log('Êà™ÂõæÂ∑≤Ê∑ªÂä†Âà∞Êñá‰ª∂ÂàóË°®:', file.name, 'Â§ßÂ∞è:', file.size);
            } catch (error) {
                failCount++;
                console.error('ËΩ¨Êç¢Êà™Âõæ‰∏∫Êñá‰ª∂Êó∂Âá∫Èîô:', error);
                this.showMessage(`Â§ÑÁêÜÊà™Âõæ ${i+1} Êó∂Âá∫Èîô: ${error.message}`, 'error');
            }
        }
        
        // Êõ¥Êñ∞È¢ÑËßàÊòæÁ§∫
        if (successCount > 0) {
            try {
                this.updateFilePreview(this.selectedFiles, preview);
                console.log('È¢ÑËßàÊõ¥Êñ∞ÊàêÂäüÔºåÂΩìÂâçÊñá‰ª∂Êï∞Èáè:', this.selectedFiles.length);
            } catch (updateError) {
                console.error('Êõ¥Êñ∞È¢ÑËßàÊó∂Âá∫Èîô:', updateError);
                this.showMessage('Êà™ÂõæÊ∑ªÂä†ÊàêÂäü‰ΩÜÈ¢ÑËßàÊõ¥Êñ∞Â§±Ë¥•', 'warning');
            }
        }
        
        // Ê∏ÖÁ©∫Â∑≤Â§ÑÁêÜÁöÑÊà™ÂõæÔºåÈÅøÂÖçÈáçÂ§çÊ∑ªÂä†
        this.capturedScreenshots = [];
        
        // ÊòæÁ§∫ÁªìÊûúÊ∂àÊÅØ
        if (successCount > 0) {
            this.showMessage(`ÊàêÂäüÊ∑ªÂä† ${successCount} Âº†Êà™ÂõæÂà∞ÂèçÈ¶à‰∏≠${failCount > 0 ? `Ôºå${failCount} Âº†Â§±Ë¥•` : ''}`, 'success');
        } else if (failCount > 0) {
            this.showMessage(`ÊâÄÊúâ ${failCount} Âº†Êà™ÂõæÊ∑ªÂä†Â§±Ë¥•`, 'error');
        }
    }
    
    // Â∞Übase64ËΩ¨Êç¢‰∏∫FileÂØπË±°ÔºàÂ¢ûÂº∫ÁâàÔºâ
    async base64ToFile(base64Data, filename, mimeType) {
        try {
            console.log('ÂºÄÂßãËΩ¨Êç¢base64‰∏∫FileÂØπË±°:', filename);
            
            // Â§ÑÁêÜdata URLÊ†ºÂºèÔºåÁßªÈô§data:image/png;base64,ÂâçÁºÄ
            let base64String = base64Data;
            if (base64String.includes(',')) {
                base64String = base64String.split(',')[1];
            }
            
            console.log('Â§ÑÁêÜÂêéÁöÑbase64ÈïøÂ∫¶:', base64String.length);
            
            // Â∞Übase64ËΩ¨Êç¢‰∏∫‰∫åËøõÂà∂Êï∞ÊçÆ
            const byteCharacters = atob(base64String);
            const byteNumbers = new Array(byteCharacters.length);
            
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: mimeType });
            
            console.log('BlobÂàõÂª∫ÊàêÂäüÔºåÂ§ßÂ∞è:', blob.size);
            
            // ‰ΩøÁî®ÂÖºÂÆπÊÄßÊõ¥Â•ΩÁöÑÊñπÂºèÂàõÂª∫FileÂØπË±°
            let file;
            try {
                // Â∞ùËØï‰ΩøÁî®FileÊûÑÈÄ†ÂáΩÊï∞
                file = new File([blob], filename, {
                    type: mimeType,
                    lastModified: Date.now()
                });
                console.log('FileÂØπË±°ÂàõÂª∫ÊàêÂäü:', file.name, file.size);
            } catch (fileError) {
                console.warn('FileÊûÑÈÄ†ÂáΩÊï∞Â§±Ë¥•Ôºå‰ΩøÁî®BlobÊõø‰ª£:', fileError);
                // Â¶ÇÊûúFileÊûÑÈÄ†ÂáΩÊï∞‰∏çÂèØÁî®ÔºåÂàõÂª∫‰∏Ä‰∏™Á±ª‰ººFileÁöÑBlobÂØπË±°
                file = blob;
                file.name = filename;
                file.lastModified = Date.now();
                // Á°Æ‰øùtypeÂ±ûÊÄßÂ≠òÂú®
                if (!file.type) {
                    Object.defineProperty(file, 'type', { value: mimeType });
                }
            }
            
            return file;
        } catch (error) {
            console.error('base64ËΩ¨FileÂ§±Ë¥•:', error);
            throw error;
        }
    }
    
    setupFeedbackFormListeners() {
        const fileInput = document.getElementById('mcp-feedback-files');
        const dropZone = document.getElementById('mcp-feedback-drop-zone');
        const preview = document.getElementById('mcp-feedback-preview');
        const submitBtn = document.getElementById('mcp-feedback-submit');
        
        // ‰ΩøÁî®ÂÆû‰æãÂèòÈáèËÄå‰∏çÊòØÂ±ÄÈÉ®ÂèòÈáè
        if (!this.selectedFiles) {
            this.selectedFiles = [];
        }
        
        // Êñá‰ª∂ÈÄâÊã©Â§ÑÁêÜ
        if (fileInput) {
            fileInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                await this.handleFileSelection(files, this.selectedFiles, preview);
            });
        }
        
        // ÊãñÊãΩÂå∫ÂüüÁÇπÂáªÂ§ÑÁêÜ
        if (dropZone) {
            dropZone.addEventListener('click', () => {
                fileInput.click();
            });
        }
        
        // ÊãñÊãΩ‰∫ã‰ª∂Â§ÑÁêÜ
        if (dropZone) {
            // ÈòªÊ≠¢ÈªòËÆ§ÊãñÊãΩË°å‰∏∫
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, this.preventDefaults, false);
                document.body.addEventListener(eventName, this.preventDefaults, false);
            });
            
            // ÊãñÊãΩËøõÂÖ•ÂíåÁ¶ªÂºÄÁöÑËßÜËßâÂèçÈ¶à
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.add('active');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.remove('active');
                }, false);
            });
            
            // Â§ÑÁêÜÊñá‰ª∂ÊãñÊãΩÊîæÁΩÆ
            dropZone.addEventListener('drop', async (e) => {
                const dt = e.dataTransfer;
                const files = Array.from(dt.files).filter(file => file.type.startsWith('image/'));
                
                if (files.length > 0) {
                    await this.handleFileSelection(files, this.selectedFiles, preview);
                } else {
                    this.showMessage('ËØ∑ÊãñÊãΩÂõæÁâáÊñá‰ª∂', 'error');
                }
            }, false);
        }
        
        // Êèê‰∫§ÊåâÈíÆÂ§ÑÁêÜ
        if (submitBtn) {
            submitBtn.addEventListener('click', () => {
                this.submitFeedback(this.selectedFiles);
            });
        }
        
        // ÁÇπÂáªÈÅÆÁΩ©ÂÖ≥Èó≠
        if (this.feedbackOverlay) {
            this.feedbackOverlay.addEventListener('click', (e) => {
                if (e.target === this.feedbackOverlay) {
                    this.hideFeedbackForm();
                }
            });
        }
    }
    
    preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    async handleFileSelection(newFiles, selectedFiles, preview) {
        const compressedFiles = [];
        
        for (const file of newFiles) {
            if (file.type.startsWith('image/')) {
                try {
                    const compressedFile = await this.compressImage(file);
                    compressedFiles.push(compressedFile);
                } catch (error) {
                    console.warn('ÂõæÁâáÂéãÁº©Â§±Ë¥•Ôºå‰ΩøÁî®ÂéüÊñá‰ª∂:', error);
                    compressedFiles.push(file);
                }
            }
        }
        
        selectedFiles.push(...compressedFiles);
        this.updateFilePreview(selectedFiles, preview);
    }
    
    async compressImage(file, maxWidth = 1920, maxHeight = 1080, quality = 0.8) {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = () => {
                // ËÆ°ÁÆóÊñ∞ÁöÑÂ∞∫ÂØ∏
                let { width, height } = img;
                
                if (width > maxWidth || height > maxHeight) {
                    const ratio = Math.min(maxWidth / width, maxHeight / height);
                    width *= ratio;
                    height *= ratio;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // ÁªòÂà∂ÂéãÁº©ÂêéÁöÑÂõæÁâá
                ctx.drawImage(img, 0, 0, width, height);
                
                // ËΩ¨Êç¢‰∏∫Blob
                canvas.toBlob((blob) => {
                    const compressedFile = new File([blob], file.name, {
                        type: file.type,
                        lastModified: Date.now()
                    });
                    resolve(compressedFile);
                }, file.type, quality);
            };
            
            img.src = URL.createObjectURL(file);
        });
    }
    
    updateFilePreview(files, previewContainer) {
        if (!previewContainer) {
            console.error('È¢ÑËßàÂÆπÂô®‰∏çÂ≠òÂú®');
            return;
        }
        
        console.log('Êõ¥Êñ∞Êñá‰ª∂È¢ÑËßàÔºåÊñá‰ª∂Êï∞Èáè:', files.length);
        previewContainer.innerHTML = '';
        
        files.forEach((file, index) => {
            console.log(`Â§ÑÁêÜÈ¢ÑËßàÊñá‰ª∂ ${index+1}:`, file.name, file.type, file.size);
            
            if (file.type && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    console.log(`Êñá‰ª∂ ${index+1} ËØªÂèñÊàêÂäü`);
                    
                    const item = document.createElement('div');
                    item.className = 'mcp-feedback-preview-item';
                    item.dataset.fileIndex = index;
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'mcp-feedback-preview-image';
                    img.alt = 'Preview';
                    img.onload = () => {
                        console.log(`ÂõæÁâá ${index+1} È¢ÑËßàÂä†ËΩΩÊàêÂäü`);
                    };
                    img.onerror = () => {
                        console.error(`ÂõæÁâá ${index+1} È¢ÑËßàÂä†ËΩΩÂ§±Ë¥•`);
                        img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yMCAyOEMyNCA0IDI4IDIwIDI4IDIwQzI4IDI0IDI0IDI4IDIwIDI4WiIgZmlsbD0iIzlDQTNBRiIvPgo8L3N2Zz4K';
                        img.title = 'ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•';
                    };
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'mcp-feedback-preview-remove';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const fileIndex = parseInt(item.dataset.fileIndex);
                        console.log(`Âà†Èô§Êñá‰ª∂ ${fileIndex+1}`);
                        files.splice(fileIndex, 1);
                        this.selectedFiles = files; // Êõ¥Êñ∞ÂÆû‰æãÂèòÈáè
                        this.updateFilePreview(this.selectedFiles, previewContainer);
                    };
                    
                    item.appendChild(img);
                    item.appendChild(removeBtn);
                    previewContainer.appendChild(item);
                };
                
                reader.onerror = (error) => {
                    console.error(`Êñá‰ª∂ ${index+1} ËØªÂèñÂ§±Ë¥•:`, error);
                };
                
                reader.readAsDataURL(file);
            } else {
                console.warn(`Êñá‰ª∂ ${index+1} ‰∏çÊòØÂõæÁâáÁ±ªÂûã:`, file.type);
            }
        });
        
        console.log('Êñá‰ª∂È¢ÑËßàÊõ¥Êñ∞ÂÆåÊàê');
    }
    
    async submitFeedback(files) {
        console.log('Submitting feedback with files:', files);
        
        try {
            const textArea = document.getElementById('mcp-feedback-text');
            const feedbackText = textArea ? textArea.value.trim() : '';
            
            if (!feedbackText && files.length === 0) {
                this.showMessage('ËØ∑Ëá≥Â∞ëÊèê‰æõÊñáÂ≠óÂèçÈ¶àÊàñÂõæÁâá', 'error');
                return;
            }
            
            // ÊòæÁ§∫Êèê‰∫§‰∏≠Áä∂ÊÄÅ
            const submitButton = document.querySelector('.mcp-feedback-button-primary');
            if (submitButton) {
                submitButton.textContent = 'Êèê‰∫§‰∏≠...';
                submitButton.disabled = true;
            }
            
            // Â§ÑÁêÜÂõæÁâáÊñá‰ª∂
            const imageData = [];
            if (files && files.length > 0) {
                console.log('Processing', files.length, 'files');
                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        try {
                            const base64 = await this.fileToBase64(file);
                            imageData.push({
                                name: file.name,
                                type: file.type,
                                size: file.size,
                                data: base64
                            });
                            console.log('Processed image:', file.name);
                        } catch (fileError) {
                            console.error('Error processing file:', file.name, fileError);
                            this.showMessage(`Â§ÑÁêÜÊñá‰ª∂ ${file.name} Êó∂Âá∫Èîô`, 'error');
                        }
                    }
                }
            }
            
            const feedbackData = {
                textFeedback: feedbackText,
                images: imageData,
                pageInfo: this.getPageInfo(),
                timestamp: new Date().toISOString()
            };
            
            console.log('Sending feedback data to background script:', feedbackData);
            
            // ÂèëÈÄÅÂà∞ background script
            chrome.runtime.sendMessage({
                action: 'submitFeedback',
                data: feedbackData
            }, (response) => {
                console.log('Background script response:', response);
                
                if (response && response.success) {
                    // Êèê‰∫§ÊàêÂäüÂêéÁ´ãÂç≥Ê∏ÖÁ©∫Ë°®ÂçïÂπ∂Á¶ÅÁî®
                    this.clearAndDisableFeedbackForm();
                    this.showMessage('ÂèçÈ¶àÂ∑≤Êèê‰∫§ÔºåÁ≠âÂæÖÊúçÂä°Âô®Á°ÆËÆ§...', 'info');
                    
                    // ‰∏çÁ´ãÂç≥ÂÖ≥Èó≠Ë°®ÂçïÔºåÁ≠âÂæÖMCPÊúçÂä°Âô®Á°ÆËÆ§
                } else {
                    const errorMsg = response?.error || 'Êú™Áü•ÈîôËØØ';
                    this.showMessage('ÂèçÈ¶àÊèê‰∫§Â§±Ë¥•Ôºö' + errorMsg, 'error');
                
                // ÊÅ¢Â§çÊèê‰∫§ÊåâÈíÆÁä∂ÊÄÅ
                if (submitButton) {
                    submitButton.textContent = 'Êèê‰∫§ÂèçÈ¶à';
                    submitButton.disabled = false;
                    }
                }
            });
            
        } catch (error) {
            console.error('Submit feedback error:', error);
            let errorMessage = 'ÂèçÈ¶àÊèê‰∫§Â§±Ë¥•Ôºö';
            
            if (error.message.includes('Extension context invalidated')) {
                errorMessage += 'Êâ©Â±ïÂ∑≤ÈáçÊñ∞Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï';
            } else if (error.message.includes('Could not establish connection')) {
                errorMessage += 'Êó†Ê≥ïËøûÊé•Âà∞ÂêéÂè∞ÊúçÂä°ÔºåËØ∑Ê£ÄÊü•Êâ©Â±ïÁä∂ÊÄÅ';
            } else {
                errorMessage += error.message;
            }
            
            this.showMessage(errorMessage, 'error');
            
            // ÊÅ¢Â§çÊèê‰∫§ÊåâÈíÆÁä∂ÊÄÅ
            const submitButton = document.querySelector('.mcp-feedback-button-primary');
            if (submitButton) {
                submitButton.textContent = 'Êèê‰∫§ÂèçÈ¶à';
                submitButton.disabled = false;
            }
        }
    }
    
    fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }
    
    clearAndDisableFeedbackForm() {
        console.log('Ê∏ÖÁ©∫Âπ∂Á¶ÅÁî®ÂèçÈ¶àË°®Âçï');
        
        // Ê∏ÖÁ©∫ÊñáÊú¨Âå∫Âüü
        const textArea = document.getElementById('mcp-feedback-text');
        if (textArea) {
            textArea.value = '';
            textArea.disabled = true;
            textArea.placeholder = 'Á≠âÂæÖÊúçÂä°Âô®Á°ÆËÆ§‰∏≠...';
        }
        
        // Ê∏ÖÁ©∫ÂõæÁâáÂàóË°®
        this.selectedFiles = [];
        this.capturedScreenshots = [];
        const preview = document.getElementById('mcp-feedback-preview');
        if (preview) {
            preview.innerHTML = '';
        }
        
        // Á¶ÅÁî®Êñá‰ª∂‰∏ä‰º†
        const fileInput = document.getElementById('mcp-feedback-files');
        if (fileInput) {
            fileInput.disabled = true;
            fileInput.value = '';
        }
        
        // Á¶ÅÁî®ÊãñÊãΩÂå∫Âüü
        const dropZone = document.getElementById('mcp-feedback-drop-zone');
        if (dropZone) {
            dropZone.style.pointerEvents = 'none';
            dropZone.style.opacity = '0.5';
            dropZone.innerHTML = `
                <div class="mcp-feedback-drop-content">
                    <div class="mcp-feedback-drop-icon">‚è≥</div>
                    <div class="mcp-feedback-drop-text">Á≠âÂæÖÊúçÂä°Âô®Á°ÆËÆ§‰∏≠...</div>
                    <div class="mcp-feedback-drop-hint">ÂèçÈ¶àÂ∑≤Êèê‰∫§ÔºåËØ∑Á≠âÂæÖÁ°ÆËÆ§</div>
                </div>
            `;
        }
        
        // Á¶ÅÁî®Êèê‰∫§ÊåâÈíÆ
        const submitButton = document.getElementById('mcp-feedback-submit');
        if (submitButton) {
            submitButton.textContent = 'Á≠âÂæÖÁ°ÆËÆ§‰∏≠...';
            submitButton.disabled = true;
        }
        
        console.log('ÂèçÈ¶àË°®ÂçïÂ∑≤Ê∏ÖÁ©∫Âπ∂Á¶ÅÁî®');
    }

    enableFeedbackForm() {
        console.log('ÈáçÊñ∞ÂêØÁî®ÂèçÈ¶àË°®Âçï');
        
        // ÂêØÁî®ÊñáÊú¨Âå∫Âüü
        const textArea = document.getElementById('mcp-feedback-text');
        if (textArea) {
            textArea.disabled = false;
            textArea.placeholder = 'ËØ∑ÊèèËø∞ÊÇ®ÁöÑÈóÆÈ¢ò„ÄÅÂª∫ËÆÆÊàñÊÑèËßÅ...';
        }
        
        // ÂêØÁî®Êñá‰ª∂‰∏ä‰º†
        const fileInput = document.getElementById('mcp-feedback-files');
        if (fileInput) {
            fileInput.disabled = false;
        }
        
        // ÊÅ¢Â§çÊãñÊãΩÂå∫Âüü
        const dropZone = document.getElementById('mcp-feedback-drop-zone');
        if (dropZone) {
            dropZone.style.pointerEvents = 'auto';
            dropZone.style.opacity = '1';
            dropZone.innerHTML = `
                <div class="mcp-feedback-drop-content">
                    <div class="mcp-feedback-drop-icon">üìÅ</div>
                    <div class="mcp-feedback-drop-text">ÊãñÊãΩÂõæÁâáÂà∞Ê≠§Â§ÑÊàñÁÇπÂáªÈÄâÊã©Êñá‰ª∂</div>
                    <div class="mcp-feedback-drop-hint">ÊîØÊåÅ JPG„ÄÅPNG„ÄÅGIF Ê†ºÂºèÔºåËá™Âä®ÂéãÁº©</div>
                </div>
            `;
        }
        
        // ÊÅ¢Â§çÊèê‰∫§ÊåâÈíÆ
        const submitButton = document.getElementById('mcp-feedback-submit');
        if (submitButton) {
            submitButton.textContent = 'Êèê‰∫§ÂèçÈ¶à';
            submitButton.disabled = false;
        }
        
        console.log('ÂèçÈ¶àË°®ÂçïÂ∑≤ÈáçÊñ∞ÂêØÁî®');
    }

    setFormDisabledState(message = 'Á≠âÂæÖÊúçÂä°Âô®ËøûÊé•...') {
        console.log('ËÆæÁΩÆË°®Âçï‰∏∫Á¶ÅÁî®Áä∂ÊÄÅ:', message);
        
        // Á¶ÅÁî®ÊñáÊú¨Âå∫Âüü
        const textArea = document.getElementById('mcp-feedback-text');
        if (textArea) {
            textArea.disabled = true;
            textArea.placeholder = message;
            textArea.value = '';
        }
        
        // Á¶ÅÁî®Êñá‰ª∂‰∏ä‰º†
        const fileInput = document.getElementById('mcp-feedback-files');
        if (fileInput) {
            fileInput.disabled = true;
            fileInput.value = '';
        }
        
        // Á¶ÅÁî®ÊãñÊãΩÂå∫Âüü
        const dropZone = document.getElementById('mcp-feedback-drop-zone');
        if (dropZone) {
            dropZone.style.pointerEvents = 'none';
            dropZone.style.opacity = '0.5';
            dropZone.innerHTML = `
                <div class="mcp-feedback-drop-content">
                    <div class="mcp-feedback-drop-icon">üîå</div>
                    <div class="mcp-feedback-drop-text">${message}</div>
                    <div class="mcp-feedback-drop-hint">ËØ∑ÂÖàËøûÊé•Âà∞MCPÊúçÂä°Âô®</div>
                </div>
            `;
        }
        
        // Á¶ÅÁî®Êèê‰∫§ÊåâÈíÆ
        const submitButton = document.getElementById('mcp-feedback-submit');
        if (submitButton) {
            submitButton.textContent = 'ËØ∑ÂÖàËøûÊé•MCPÊúçÂä°Âô®';
            submitButton.disabled = true;
        }
    }

    async checkMCPConnectionStatus() {
        try {
            console.log('Ê£ÄÊü•MCPËøûÊé•Áä∂ÊÄÅ...');
            const response = await new Promise((resolve) => {
                chrome.runtime.sendMessage({
                    action: 'getConnectionStatus'
                }, resolve);
            });
            
            console.log('MCPËøûÊé•Áä∂ÊÄÅ:', response);
            
            if (response && response.isConnected) {
                console.log('MCPÂ∑≤ËøûÊé•ÔºåÂêØÁî®ÂèçÈ¶àË°®Âçï');
                this.enableFeedbackForm();
                this.showMessage('MCPÊúçÂä°Âô®Â∑≤ËøûÊé•ÔºåÂèØ‰ª•Êèê‰∫§ÂèçÈ¶à', 'success');
            } else {
                console.log('MCPÊú™ËøûÊé•Ôºå‰øùÊåÅË°®ÂçïÁ¶ÅÁî®Áä∂ÊÄÅ');
                this.setFormDisabledState('MCPÊúçÂä°Âô®Êú™ËøûÊé•');
            }
        } catch (error) {
            console.error('Ê£ÄÊü•MCPËøûÊé•Áä∂ÊÄÅÂ§±Ë¥•:', error);
            this.setFormDisabledState('ËøûÊé•Áä∂ÊÄÅÊ£ÄÊü•Â§±Ë¥•');
        }
    }
    
    hideFeedbackForm() {
        if (this.feedbackOverlay) {
            this.feedbackOverlay.remove();
            this.feedbackOverlay = null;
        }
    }
    
    handleKeyDown(event) {
        // F2: ÊâìÂºÄÂèçÈ¶àË°®Âçï
        if (event.key === 'F2' && this.isActive) {
            event.preventDefault();
            this.showFeedbackForm();
        }
        
        // ESC: ÂÖ≥Èó≠ÂèçÈ¶àË°®Âçï
        if (event.key === 'Escape' && this.feedbackOverlay) {
            event.preventDefault();
            this.hideFeedbackForm();
        }
    }
    
    showMessage(text, type = 'success') {
        const message = document.createElement('div');
        message.className = `mcp-feedback-message mcp-feedback-message-${type}`;
        message.textContent = text;
        
        document.body.appendChild(message);
        
        setTimeout(() => {
            message.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                if (message.parentNode) {
                    message.remove();
                }
            }, 300);
        }, 3000);
    }
    
    // Â§ÑÁêÜËá™Âä®ÂåñÂëΩ‰ª§
    async handleAutomationCommand(request) {
        console.log('Â§ÑÁêÜËá™Âä®ÂåñÂëΩ‰ª§:', request.type, request.data);

        try {
            switch (request.type) {
                case 'navigate':
                    return await this.automateNavigate(request.data);

                case 'click':
                    return await this.automateClick(request.data);

                case 'fillInput':
                    return await this.automateFillInput(request.data);

                case 'executeScript':
                    return await this.automateExecuteScript(request.data);

                case 'getPageInfo':
                    return await this.automateGetPageInfo(request.data);

                case 'takeScreenshot':
                    return await this.automateTakeScreenshot(request.data);

                case 'waitForElement':
                    return await this.automateWaitForElement(request.data);

                // Êñ∞Â¢ûÔºöÊô∫ËÉΩË°®ÂçïÂ°´ÂÜô
                case 'fillForm':
                    return await this.automateSmartFillForm(request.data);

                // Êñ∞Â¢ûÔºöÊô∫ËÉΩÂÖÉÁ¥†‰∫§‰∫í
                case 'interactElement':
                    return await this.automateSmartInteract(request.data);

                // Êñ∞Â¢ûÔºöÂÜÖÂÆπÊèêÂèñ
                case 'extractContent':
                    return await this.automateExtractContent(request.data);

                default:
                    throw new Error(`Unknown automation command: ${request.type}`);
            }
        } catch (error) {
            console.error('Ëá™Âä®ÂåñÂëΩ‰ª§ÊâßË°åÂ§±Ë¥•:', error);
            throw error;
        }
    }

    // Êñ∞Â¢ûÔºöÊô∫ËÉΩË°®ÂçïÂ°´ÂÜôÊñπÊ≥ï
    async automateSmartFillForm(data) {
        const { formData, submitAfter = false } = data;
        console.log('Êô∫ËÉΩË°®ÂçïÂ°´ÂÜô:', formData);

        const results = [];
        let successCount = 0;

        for (const [fieldName, value] of Object.entries(formData)) {
            try {
                const result = await this.smartFillField(fieldName, value);
                results.push(result);
                if (result.success) successCount++;
            } catch (error) {
                results.push({
                    success: false,
                    fieldName,
                    error: error.message
                });
            }
        }

        // Â¶ÇÊûúÈúÄË¶ÅÊèê‰∫§Ë°®Âçï
        if (submitAfter) {
            try {
                const submitButton = this.findSubmitButton();
                if (submitButton) {
                    await this.waitForDelay(500); // Á≠âÂæÖË°®ÂçïÁä∂ÊÄÅÊõ¥Êñ∞
                    submitButton.click();
                    results.push({ success: true, action: 'submit', message: 'Form submitted' });
                }
            } catch (error) {
                results.push({ success: false, action: 'submit', error: error.message });
            }
        }

        return {
            success: successCount > 0,
            totalFields: Object.keys(formData).length,
            successCount,
            results
        };
    }

    // Êô∫ËÉΩÂ≠óÊÆµÂ°´ÂÜô
    async smartFillField(fieldName, value) {
        console.log(`Â°´ÂÜôÂ≠óÊÆµ: ${fieldName} = ${value}`);

        // Â§öÁßçÁ≠ñÁï•Â∞ùËØïÂÆö‰ΩçÂ≠óÊÆµ
        const strategies = [
            // Á≠ñÁï•1: Âü∫‰∫éVueÁªÑ‰ª∂ÁöÑlabelËØÜÂà´
            () => this.findFieldByVueLabel(fieldName),
            // Á≠ñÁï•2: Âü∫‰∫éplaceholderËØÜÂà´
            () => this.findFieldByPlaceholder(fieldName),
            // Á≠ñÁï•3: Âü∫‰∫élabelÂÖÉÁ¥†ËØÜÂà´
            () => this.findFieldByLabel(fieldName),
            // Á≠ñÁï•4: Âü∫‰∫énameÂ±ûÊÄßËØÜÂà´
            () => this.findFieldByName(fieldName),
            // Á≠ñÁï•5: Âü∫‰∫éidËØÜÂà´
            () => this.findFieldById(fieldName),
            // Á≠ñÁï•6: Êô∫ËÉΩÊñáÊú¨ÂåπÈÖç
            () => this.findFieldBySmartText(fieldName)
        ];

        let element = null;
        let strategy = '';

        for (let i = 0; i < strategies.length; i++) {
            element = strategies[i]();
            if (element) {
                strategy = `strategy_${i + 1}`;
                break;
            }
        }

        if (!element) {
            throw new Error(`Field not found: ${fieldName}`);
        }

        // Ê†πÊçÆÂÖÉÁ¥†Á±ªÂûãËøõË°åÊô∫ËÉΩÂ°´ÂÜô
        const result = await this.smartFillElement(element, value, fieldName);
        result.strategy = strategy;
        result.fieldName = fieldName;

        return result;
    }

    // Âü∫‰∫éVueÁªÑ‰ª∂labelÊü•ÊâæÂ≠óÊÆµ
    findFieldByVueLabel(labelText) {
        // Êü•ÊâæÂåÖÂê´ÊåáÂÆöÊñáÊú¨ÁöÑVueË°®ÂçïÈ°π
        const formItems = document.querySelectorAll('.el-form-item');
        for (const item of formItems) {
            const label = item.querySelector('.el-form-item__label');
            if (label && this.textMatches(label.textContent, labelText)) {
                // Êü•ÊâæÂØπÂ∫îÁöÑËæìÂÖ•Êéß‰ª∂
                return this.findInputInFormItem(item);
            }
        }
        return null;
    }

    // Âú®Ë°®ÂçïÈ°π‰∏≠Êü•ÊâæËæìÂÖ•Êéß‰ª∂
    findInputInFormItem(formItem) {
        // Êåâ‰ºòÂÖàÁ∫ßÊü•ÊâæÂêÑÁßçËæìÂÖ•Êéß‰ª∂
        const selectors = [
            'input[type="text"]',
            'input:not([type="hidden"])',
            'textarea',
            '.el-input input',
            '.el-textarea textarea',
            '.el-select',
            '.el-date-editor',
            '.el-time-picker',
            '.el-checkbox',
            '.el-radio'
        ];

        for (const selector of selectors) {
            const element = formItem.querySelector(selector);
            if (element && this.isInteractableElement(element)) {
                return element;
            }
        }
        return null;
    }

    // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶ÂèØ‰∫§‰∫í
    isInteractableElement(element) {
        if (!element) return false;
        
        const style = window.getComputedStyle(element);
        const rect = element.getBoundingClientRect();

        return !element.disabled &&
               style.display !== 'none' &&
               style.visibility !== 'hidden' &&
               rect.width > 0 &&
               rect.height > 0;
    }

    // ÊñáÊú¨ÂåπÈÖçÂáΩÊï∞
    textMatches(text1, text2) {
        if (!text1 || !text2) return false;
        
        const normalize = (str) => str.replace(/[*\s:Ôºö]/g, '').toLowerCase();
        return normalize(text1).includes(normalize(text2)) || 
               normalize(text2).includes(normalize(text1));
    }

    // Âü∫‰∫éplaceholderÊü•Êâæ
    findFieldByPlaceholder(fieldName) {
        const selector = `input[placeholder*="${fieldName}"], textarea[placeholder*="${fieldName}"]`;
        return document.querySelector(selector);
    }

    // Âü∫‰∫élabelÊü•Êâæ
    findFieldByLabel(fieldName) {
        const labels = document.querySelectorAll('label');
        for (const label of labels) {
            if (this.textMatches(label.textContent, fieldName)) {
                const target = label.getAttribute('for');
                if (target) {
                    return document.getElementById(target);
                }
                // Êü•ÊâælabelÂÜÖÈÉ®ÁöÑËæìÂÖ•ÂÖÉÁ¥†
                const input = label.querySelector('input, textarea, select');
                if (input) return input;
            }
        }
        return null;
    }

    // Âü∫‰∫énameÂ±ûÊÄßÊü•Êâæ
    findFieldByName(fieldName) {
        const normalizedName = fieldName.toLowerCase().replace(/[^a-z0-9]/g, '');
        const inputs = document.querySelectorAll('input, textarea, select');
        
        for (const input of inputs) {
            const name = (input.name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            if (name.includes(normalizedName) || normalizedName.includes(name)) {
                return input;
            }
        }
        return null;
    }

    // Âü∫‰∫éidÊü•Êâæ
    findFieldById(fieldName) {
        const normalizedName = fieldName.toLowerCase().replace(/[^a-z0-9]/g, '');
        const inputs = document.querySelectorAll('input, textarea, select');
        
        for (const input of inputs) {
            const id = (input.id || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            if (id.includes(normalizedName) || normalizedName.includes(id)) {
                return input;
            }
        }
        return null;
    }

    // Êô∫ËÉΩÊñáÊú¨ÂåπÈÖçÊü•Êâæ
    findFieldBySmartText(fieldName) {
        // Êü•ÊâæÈôÑËøëÊúâÁõ∏ÂÖ≥ÊñáÊú¨ÁöÑËæìÂÖ•Ê°Ü
        const inputs = document.querySelectorAll('input, textarea, select');
        
        for (const input of inputs) {
            // Ê£ÄÊü•Áà∂Á∫ßÂÖÉÁ¥†‰∏≠ÊòØÂê¶ÂåÖÂê´Áõ∏ÂÖ≥ÊñáÊú¨
            let parent = input.parentElement;
            let level = 0;
            
            while (parent && level < 3) {
                if (this.textMatches(parent.textContent, fieldName)) {
                    return input;
                }
                parent = parent.parentElement;
                level++;
            }
        }
        return null;
    }

    // Êô∫ËÉΩÂ°´ÂÜôÂÖÉÁ¥†
    async smartFillElement(element, value, fieldName) {
        console.log(`Êô∫ËÉΩÂ°´ÂÜôÂÖÉÁ¥†:`, element.tagName, element.type, value);

        // ÊªöÂä®Âà∞ÂÖÉÁ¥†‰ΩçÁΩÆ
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        await this.waitForDelay(300);

        // Ê†πÊçÆÂÖÉÁ¥†Á±ªÂûãÈÄâÊã©Â°´ÂÜôÁ≠ñÁï•
        if (element.classList.contains('el-select') || element.closest('.el-select')) {
            return await this.fillVueSelect(element, value, fieldName);
        } else if (element.classList.contains('el-date-editor') || element.closest('.el-date-editor')) {
            return await this.fillVueDatePicker(element, value, fieldName);
        } else if (element.type === 'checkbox' || element.classList.contains('el-checkbox')) {
            return await this.fillVueCheckbox(element, value, fieldName);
        } else if (element.type === 'radio' || element.classList.contains('el-radio')) {
            return await this.fillVueRadio(element, value, fieldName);
        } else if (element.tagName === 'TEXTAREA' || element.type === 'text') {
            return await this.fillVueInput(element, value, fieldName);
        } else {
            // ÈªòËÆ§ÊñáÊú¨Â°´ÂÜô
            return await this.fillVueInput(element, value, fieldName);
        }
    }

    // Vue SelectÂ°´ÂÜô
    async fillVueSelect(element, value, fieldName) {
        const selectWrapper = element.closest('.el-select') || element;
        const input = selectWrapper.querySelector('input') || selectWrapper;

        // ÁÇπÂáªÊâìÂºÄ‰∏ãÊãâÊ°Ü
        selectWrapper.click();
        await this.waitForDelay(500);

        // Êü•ÊâæÂåπÈÖçÁöÑÈÄâÈ°π
        const options = document.querySelectorAll('.el-option');
        let selectedOption = null;

        for (const option of options) {
            if (this.textMatches(option.textContent, value)) {
                selectedOption = option;
                break;
            }
        }

        if (selectedOption) {
            selectedOption.click();
            await this.waitForDelay(200);
            return { success: true, message: `Selected option: ${value}` };
        } else {
            // Â¶ÇÊûúÊ≤°ÊâæÂà∞ÈÄâÈ°πÔºåÂ∞ùËØïÁõ¥Êé•ËæìÂÖ•
            if (input) {
                input.focus();
                input.value = value;
                this.triggerVueEvents(input);
            }
            return { success: false, message: `Option not found: ${value}` };
        }
    }

    // Vue DatePickerÂ°´ÂÜô
    async fillVueDatePicker(element, value, fieldName) {
        const dateWrapper = element.closest('.el-date-editor') || element;
        const input = dateWrapper.querySelector('input') || dateWrapper;

        // ËÅöÁÑ¶Âπ∂Â°´ÂÜôÊó•Êúü
        input.focus();
        input.value = value;
        this.triggerVueEvents(input);

        // Â§±ÂéªÁÑ¶ÁÇπ‰ª•Ëß¶ÂèëÊó•ÊúüËß£Êûê
        input.blur();
        await this.waitForDelay(200);

        return { success: true, message: `Date filled: ${value}` };
    }

    // Vue CheckboxÂ°´ÂÜô
    async fillVueCheckbox(element, shouldCheck, fieldName) {
        const checkboxWrapper = element.closest('.el-checkbox') || element;
        const isCurrentlyChecked = element.checked || checkboxWrapper.classList.contains('is-checked');
        
        const needsToggle = (shouldCheck && !isCurrentlyChecked) || (!shouldCheck && isCurrentlyChecked);
        
        if (needsToggle) {
            checkboxWrapper.click();
            await this.waitForDelay(200);
        }

        return { success: true, message: `Checkbox ${shouldCheck ? 'checked' : 'unchecked'}` };
    }

    // Vue RadioÂ°´ÂÜô
    async fillVueRadio(element, value, fieldName) {
        // Êü•ÊâæÂåπÈÖçÁöÑradioÈÄâÈ°π
        const radioGroup = element.closest('.el-radio-group');
        if (radioGroup) {
            const radios = radioGroup.querySelectorAll('.el-radio');
            for (const radio of radios) {
                if (this.textMatches(radio.textContent, value)) {
                    radio.click();
                    await this.waitForDelay(200);
                    return { success: true, message: `Radio selected: ${value}` };
                }
            }
        } else {
            // Âçï‰∏™radio
            if (this.textMatches(element.textContent || element.value, value)) {
                element.click();
                return { success: true, message: `Radio selected: ${value}` };
            }
        }

        return { success: false, message: `Radio option not found: ${value}` };
    }

    // Vue InputÂ°´ÂÜô
    async fillVueInput(element, value, fieldName) {
        // ËÅöÁÑ¶ÂÖÉÁ¥†
        element.focus();
        await this.waitForDelay(100);

        // Ê∏ÖÁ©∫Áé∞ÊúâÂÄº
        element.value = '';
        this.triggerVueEvents(element);

        // Ê®°ÊãüÈÄêÂ≠óÁ¨¶ËæìÂÖ•
        for (let i = 0; i < value.length; i++) {
            element.value += value[i];
            this.triggerVueEvents(element);
            await this.waitForDelay(30); // Ê®°ÊãüÁúüÂÆûËæìÂÖ•
        }

        // Â§±ÂéªÁÑ¶ÁÇπ
        element.blur();
        await this.waitForDelay(100);

        return { success: true, message: `Input filled: ${value}` };
    }

    // Ëß¶ÂèëVueÁõ∏ÂÖ≥‰∫ã‰ª∂
    triggerVueEvents(element) {
        // Ëß¶ÂèëÂ∏∏ËßÅÁöÑVue‰∫ã‰ª∂
        const events = ['input', 'change', 'blur', 'focus'];
        events.forEach(eventType => {
            element.dispatchEvent(new Event(eventType, { bubbles: true }));
        });

        // Ëß¶ÂèëVueÁâπÂÆö‰∫ã‰ª∂
        if (element.__vue__ || element._vueParentComponent) {
            // Vue 2/3 ÂÖºÂÆπÊÄß
            const changeEvent = new CustomEvent('vue:change', { 
                bubbles: true, 
                detail: { value: element.value }
            });
            element.dispatchEvent(changeEvent);
        }
    }

    // Êü•ÊâæÊèê‰∫§ÊåâÈíÆ
    findSubmitButton() {
        const selectors = [
            'button[type="submit"]',
            'input[type="submit"]',
            '.el-button--primary',
            'button:contains("Êèê‰∫§")',
            'button:contains("Á´ãÂç≥ÂàõÂª∫")',
            'button:contains("Á°ÆÂÆö")',
            'button:contains("‰øùÂ≠ò")'
        ];

        for (const selector of selectors) {
            const button = document.querySelector(selector);
            if (button && this.isInteractableElement(button)) {
                return button;
            }
        }

        // Êü•ÊâæÂåÖÂê´Êèê‰∫§Áõ∏ÂÖ≥ÊñáÊú¨ÁöÑÊåâÈíÆ
        const buttons = document.querySelectorAll('button');
        for (const button of buttons) {
            const text = button.textContent.trim();
            if (/Êèê‰∫§|Á´ãÂç≥ÂàõÂª∫|Á°ÆÂÆö|‰øùÂ≠ò|submit/i.test(text)) {
                return button;
            }
        }

        return null;
    }

    // Á≠âÂæÖÂª∂Ëøü
    async waitForDelay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    cleanup() {
        this.stopFeedbackCollection();

        // Ê∏ÖÁêÜÊà™ÂõæÊï∞ÊçÆ
        this.capturedScreenshots = [];
        this.selectedFiles = [];

        // ÁßªÈô§Ê†∑Âºè
        const styles = document.getElementById('mcp-feedback-styles');
        if (styles) {
            styles.remove();
        }
    }

    // Êñ∞Â¢ûÔºöÊô∫ËÉΩÂÖÉÁ¥†‰∫§‰∫í
    async automateSmartInteract(data) {
        const { selector, action = 'click', value = null, options = {} } = data;
        console.log('Êô∫ËÉΩÂÖÉÁ¥†‰∫§‰∫í:', selector, action, value);

        const element = document.querySelector(selector);
        if (!element) {
            throw new Error(`Element not found: ${selector}`);
        }

        // ÊªöÂä®Âà∞ÂÖÉÁ¥†‰ΩçÁΩÆ
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        await this.waitForDelay(300);

        switch (action) {
            case 'click':
                element.click();
                break;
            case 'doubleClick':
                element.dispatchEvent(new MouseEvent('dblclick', { bubbles: true }));
                break;
            case 'hover':
                element.dispatchEvent(new MouseEvent('mouseover', { bubbles: true }));
                break;
            case 'focus':
                element.focus();
                break;
            case 'blur':
                element.blur();
                break;
            case 'select':
                if (element.tagName === 'SELECT') {
                    element.value = value;
                    element.dispatchEvent(new Event('change', { bubbles: true }));
                }
                break;
            default:
                throw new Error(`Unknown action: ${action}`);
        }

        return { success: true, message: `Action ${action} performed on ${selector}` };
    }

    // Êñ∞Â¢ûÔºöÂÜÖÂÆπÊèêÂèñ
    async automateExtractContent(data) {
        const { selectors = [], type = 'text', options = {} } = data;
        console.log('ÂÜÖÂÆπÊèêÂèñ:', selectors, type);

        const results = [];

        if (selectors.length === 0) {
            // Â¶ÇÊûúÊ≤°ÊúâÊåáÂÆöÈÄâÊã©Âô®ÔºåËøîÂõûÈ°µÈù¢Âü∫Êú¨‰ø°ÊÅØ
            return {
                success: true,
                data: {
                    url: window.location.href,
                    title: document.title,
                    timestamp: new Date().toISOString()
                }
            };
        }

        for (const selector of selectors) {
            const elements = document.querySelectorAll(selector);
            const selectorResults = [];

            for (const element of elements) {
                let content = '';
                switch (type) {
                    case 'text':
                        content = element.textContent?.trim() || '';
                        break;
                    case 'html':
                        content = element.innerHTML;
                        break;
                    case 'value':
                        content = element.value || '';
                        break;
                    case 'href':
                        content = element.href || '';
                        break;
                    case 'src':
                        content = element.src || '';
                        break;
                    case 'attributes':
                        const attrs = {};
                        for (const attr of element.attributes) {
                            attrs[attr.name] = attr.value;
                        }
                        content = attrs;
                        break;
                }
                selectorResults.push(content);
            }

            results.push({
                selector,
                count: elements.length,
                content: selectorResults
            });
        }

        return { success: true, data: results };
    }

    // ÂéüÊù•ÁöÑÊñπÊ≥ïÊÅ¢Â§ç
    // ÂØºËà™Âà∞ÊåáÂÆöURL
    async automateNavigate(data) {
        const { url, waitForLoad } = data;
        console.log('ÂØºËà™Âà∞:', url);

        window.location.href = url;

        if (waitForLoad) {
            await new Promise((resolve) => {
                if (document.readyState === 'complete') {
                    resolve();
                } else {
                    window.addEventListener('load', resolve, { once: true });
                }
            });
        }

        return { success: true, message: `Successfully navigated to ${url}` };
    }

    // ÁÇπÂáªÂÖÉÁ¥†
    async automateClick(data) {
        const { selector, waitTime } = data;
        console.log('ÁÇπÂáªÂÖÉÁ¥†:', selector);

        const element = document.querySelector(selector);
        if (!element) {
            throw new Error(`Element not found: ${selector}`);
        }

        // ÊªöÂä®Âà∞ÂÖÉÁ¥†‰ΩçÁΩÆ
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Á≠âÂæÖ‰∏Ä‰∏ãÁ°Æ‰øùÊªöÂä®ÂÆåÊàê
        await new Promise(resolve => setTimeout(resolve, 500));

        // ÁÇπÂáªÂÖÉÁ¥†
        element.click();

        // Á≠âÂæÖÊåáÂÆöÊó∂Èó¥
        if (waitTime > 0) {
            await new Promise(resolve => setTimeout(resolve, waitTime));
        }

        return { success: true, message: `Clicked element: ${selector}` };
    }

    // Â°´ÂÜôËæìÂÖ•Ê°Ü
    async automateFillInput(data) {
        const { selector, text, clearFirst } = data;
        console.log('Â°´ÂÜôËæìÂÖ•Ê°Ü:', selector, 'ÂÜÖÂÆπ:', text);

        const element = document.querySelector(selector);
        if (!element) {
            throw new Error(`Input element not found: ${selector}`);
        }

        // ÊªöÂä®Âà∞ÂÖÉÁ¥†‰ΩçÁΩÆ
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // ËÅöÁÑ¶ÂÖÉÁ¥†
        element.focus();

        // Ê∏ÖÁ©∫Áé∞ÊúâÂÜÖÂÆπ
        if (clearFirst) {
            element.value = '';
            element.dispatchEvent(new Event('input', { bubbles: true }));
        }

        // Ê®°ÊãüÁî®Êà∑ËæìÂÖ•
        for (let i = 0; i < text.length; i++) {
            element.value += text[i];
            element.dispatchEvent(new Event('input', { bubbles: true }));
            await new Promise(resolve => setTimeout(resolve, 50)); // Ê®°ÊãüÁúüÂÆûËæìÂÖ•ÈÄüÂ∫¶
        }

        // Ëß¶Âèëchange‰∫ã‰ª∂
        element.dispatchEvent(new Event('change', { bubbles: true }));
        element.blur();

        return { success: true, message: `Filled input ${selector} with: ${text}` };
    }

    // ÊâßË°åJavaScript
    async automateExecuteScript(data) {
        const { script, returnResult } = data;
        console.log('ÊâßË°åËÑöÊú¨:', script.substring(0, 100) + '...');

        try {
            const result = eval(script);

            if (returnResult) {
                return {
                    success: true,
                    result: result,
                    message: 'Script executed successfully'
                };
            } else {
                return { success: true, message: 'Script executed successfully' };
            }
        } catch (error) {
            throw new Error(`Script execution failed: ${error.message}`);
        }
    }

    // Ëé∑ÂèñÈ°µÈù¢‰ø°ÊÅØ
    async automateGetPageInfo(data) {
        const { includeElements, elementSelector } = data;
        console.log('Ëé∑ÂèñÈ°µÈù¢‰ø°ÊÅØ, ÂåÖÂê´ÂÖÉÁ¥†:', includeElements);

        const pageInfo = {
            url: window.location.href,
            title: document.title,
            timestamp: new Date().toISOString()
        };

        if (includeElements) {
            const selector = elementSelector || 'input, button, textarea, select, a';
            const elements = Array.from(document.querySelectorAll(selector));

            pageInfo.elements = elements.map((el, index) => {
                const rect = el.getBoundingClientRect();
                return {
                    index,
                    tagName: el.tagName.toLowerCase(),
                    type: el.type || '',
                    id: el.id || '',
                    className: el.className || '',
                    text: el.textContent?.trim().substring(0, 100) || '',
                    href: el.href || '',
                    visible: rect.width > 0 && rect.height > 0 &&
                             window.getComputedStyle(el).display !== 'none'
                };
            });
        }

        return { success: true, data: pageInfo };
    }

    // Êà™Âõæ
    async automateTakeScreenshot(data) {
        console.log('ËØ∑Ê±ÇÊà™Âõæ');

        // ÈÄöËøábackground scriptËØ∑Ê±ÇÊà™Âõæ
        return new Promise((resolve, reject) => {
            chrome.runtime.sendMessage({
                action: 'captureElementScreenshot'
            }, (response) => {
                if (chrome.runtime.lastError) {
                    reject(new Error(chrome.runtime.lastError.message));
                } else if (response.success) {
                    resolve({
                        success: true,
                        screenshot: response.screenshot,
                        message: 'Screenshot captured successfully'
                    });
                } else {
                    reject(new Error(response.error || 'Screenshot failed'));
                }
            });
        });
    }

    // Á≠âÂæÖÂÖÉÁ¥†Âá∫Áé∞
    async automateWaitForElement(data) {
        const { selector, timeout } = data;
        console.log('Á≠âÂæÖÂÖÉÁ¥†Âá∫Áé∞:', selector);

        const startTime = Date.now();

        while (Date.now() - startTime < timeout) {
            const element = document.querySelector(selector);
            if (element && element.offsetParent !== null) {
                return {
                    success: true,
                    message: `Element found: ${selector}`,
                    waitTime: Date.now() - startTime
                };
            }
            await new Promise(resolve => setTimeout(resolve, 100));
        }

        throw new Error(`Element not found within ${timeout}ms: ${selector}`);
    }
}

// ÂàùÂßãÂåñ content script
// ÂàùÂßãÂåñÂÜÖÂÆπËÑöÊú¨
console.log('üîÑ ÂºÄÂßãÂä†ËΩΩ MCP Feedback Content Script...');

// Á´ãÂç≥ÂàùÂßãÂåñ
const mcpFeedbackContent = new MCPFeedbackContent();

// Âú®DOM readyÊó∂ÂÜçÊ¨°Á°ÆËÆ§ÂàùÂßãÂåñ
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üìÑ DOM Âä†ËΩΩÂÆåÊàêÔºåContent Script ÂáÜÂ§áÂ∞±Áª™');
    });
} else {
    console.log('üìÑ DOM Â∑≤ÁªèÂä†ËΩΩÂÆåÊàêÔºåContent Script ÂáÜÂ§áÂ∞±Áª™');
}

// ÂØºÂá∫Áî®‰∫éÊµãËØï
if (typeof module !== 'undefined' && module.exports) {
    module.exports = MCPFeedbackContent;
}