# MCP Chrome Feedback 多项目支持改造计划

## 📋 改造概述

将 MCP Chrome Feedback 从单项目模式升级为支持多项目并发的架构：
- **服务端**：单一实例 + 基于路径的路由
- **客户端**：动态项目识别 + 多项目连接管理

## 🎯 改造目标r

1. **单一服务实例**：chrome-feedback 服务只运行一个进程
2. **多项目隔离**：不同项目的反馈数据完全独立
3. **路径路由**：通过 URL 路径区分项目 (`ws://localhost:8797/ws/{projectId}`)
4. **向后兼容**：确保现有单项目模式仍然可用
5. **动态项目识别**：自动获取项目标识符

---

## 📅 分阶段执行计划

### 🚀 阶段 1：基础架构准备 (2-3小时)

#### 任务 1.1：项目识别机制设计 ✅
- [x] 定义项目 ID 生成规则
- [x] 创建项目检测工具函数
- [x] 设计兼容性策略

**验收标准**
- ✅ 能够准确识别项目名称
- ✅ 支持多种项目类型（npm, python, rust等）
- ✅ 具备降级机制（默认项目ID）

**实现文件**：`src/project-utils.ts`

#### 任务 1.2：数据结构重构 ✅
- [x] 设计多项目数据存储结构
- [x] 创建项目隔离的反馈历史管理
- [x] 实现数据迁移机制

**验收标准**：
- ✅ 现有单项目数据能够平滑迁移
- ✅ 新的多项目数据结构完整
- ✅ 数据操作API保持兼容

**实现文件**：`src/multi-project-data-manager.ts`

#### 任务 1.3：配置管理优化 ✅
- [x] 支持项目级配置
- [x] 全局配置与项目配置分离
- [x] 配置继承机制

**验收标准**：
- ✅ 项目配置能够覆盖全局配置
- ✅ 配置文件结构清晰
- ✅ 支持热更新

**实现文件**：`src/config-manager.ts` (用户简化版本)

---

### 🔧 阶段 2：服务端改造 (4-5小时)

#### 任务 2.1：WebSocket 路由系统 ✅
- [x] 实现基于路径的连接路由
- [x] 创建项目连接映射表
- [x] 添加连接生命周期管理

**实现细节**：
```typescript
// 连接映射结构
interface ProjectConnections {
  [projectId: string]: {
    connection: WebSocket;
    metadata: ProjectMetadata;
    lastActivity: Date;
  }
}

// 路径解析
// ws://localhost:8797/ws/my-project -> projectId: "my-project"
```

**验收标准**：
- ✅ 支持多项目并发连接
- ✅ 连接自动清理和重连
- ✅ 路径解析准确无误

**实现文件**：`src/multi-project-router.ts`

#### 任务 2.2：消息路由重构 ✅
- [x] 基于项目ID的消息分发
- [x] 消息格式标准化
- [x] 错误处理和日志改进

**消息格式**：
```json
{
  "type": "feedback",
  "projectId": "my-project",
  "data": { ... },
  "timestamp": "2024-01-01T00:00:00Z"
}
```

**验收标准**：
- ✅ 消息能够准确路由到对应项目 
- ✅ 支持广播和单播模式
- ✅ 异常情况处理完善

**实现文件**：`src/multi-project-chrome-feedback-manager.ts`

#### 任务 2.3：单实例启动机制 ✅
- [x] 重构服务启动逻辑（简化版本）
- [x] 移除复杂的浏览器自动化功能
- [x] 优化核心反馈功能

**验收标准**：
- ✅ 单一服务实例能够处理多项目
- ✅ 资源使用优化
- ✅ 启动速度改善

**实现文件**：`src/index.ts` (简化版本，专注核心反馈功能)

**状态说明**：阶段2基本完成，创建了简化版本专注于核心反馈功能。移除了复杂的浏览器自动化功能以降低复杂性。

---

### 🌐 阶段 3：客户端改造 (3-4小时)

#### 任务 3.1：项目识别功能 ✅
- [x] 实现多种项目类型检测
- [x] 项目名称标准化
- [x] 工作区项目扫描

**项目检测策略**：
```javascript
const projectDetectors = [
  { file: 'package.json', key: 'name' },
  { file: 'Cargo.toml', key: 'package.name' },
  { file: 'requirements.txt', fallback: 'dirname' },
  { file: 'pom.xml', key: 'artifactId' }
];
```

**验收标准**：
- ✅ 准确识别常见项目类型
- ✅ 项目名称规范化处理
- ✅ 支持手动指定项目ID

**实现文件**：`chrome-extension/project-detector.js`

#### 任务 3.2：连接管理重构 ✅
- [x] 多连接并发管理
- [x] 连接状态监控
- [x] 自动重连机制

**验收标准**：
- ✅ 支持同时连接多个项目
- ✅ 连接状态实时显示
- ✅ 网络中断自动恢复

**实现文件**：`chrome-extension/multi-project-connection-manager.js`

#### 任务 3.3：UI 界面改进 ✅
- [x] 多项目标签页设计
- [x] 项目切换功能
- [x] 反馈历史分项目显示（集成到现有界面）

**界面布局**：
```
┌─────────────────────────────────┐
│ [Project-A] [Project-B] [+New]  │
├─────────────────────────────────┤
│ Current Project: Project-A      │
│ Status: Connected ●             │
│                                 │
│ [Feedback Area]                 │
│                                 │
│ [History for Project-A]         │
└─────────────────────────────────┘
```

**验收标准**：
- ✅ 界面直观易用
- ✅ 项目切换流畅
- ✅ 数据展示清晰

**实现文件**：`chrome-extension/multi-project-ui.js`

**状态说明**：阶段3已完成！实现了完整的多项目客户端支持，包括项目自动检测、多连接管理和现代化UI界面。

---

### 🔄 阶段 4：兼容性保证 (2-3小时)

#### 任务 4.1：向后兼容性
- [ ] 旧版本连接支持
- [ ] 数据格式兼容
- [ ] 配置迁移工具

**兼容性策略**：
- 检测到旧格式连接时自动适配
- 数据结构兼容旧版本
- 提供平滑升级路径

#### 任务 4.2：降级机制
- [ ] 单项目模式支持
- [ ] 网络异常处理
- [ ] 功能开关设计

**验收标准**：
- 多项目模式异常时能降级到单项目
- 网络问题不影响基础功能
- 用户可选择启用/禁用多项目模式

---

### 🧪 阶段 5：测试与优化 (2-3小时)

#### 任务 5.1：功能测试
- [ ] 单项目场景测试
- [ ] 多项目并发测试
- [ ] 边界条件测试

**测试用例**：
- 同时连接 3-5 个不同类型项目
- 项目切换和数据隔离验证
- 网络中断和恢复测试
- 大量反馈数据处理

#### 任务 5.2：性能优化
- [ ] 内存使用优化
- [ ] 连接池管理
- [ ] 数据存储优化

**性能指标**：
- 内存占用 < 50MB (支持10个项目)
- 消息延迟 < 100ms
- 连接建立时间 < 2s

#### 任务 5.3：文档更新
- [ ] 使用说明更新
- [ ] API 文档完善
- [ ] 配置示例更新

---

## 🛡️ 风险控制策略

### 代码保护
- **分支管理**：每个阶段创建独立分支
- **版本标记**：关键节点打 tag
- **回滚计划**：每个阶段完成后确认可回滚点

### 功能保护
- **功能开关**：新功能支持开关控制
- **双模式运行**：同时支持新旧模式
- **渐进式迁移**：用户可选择升级时机

### 数据保护
- **自动备份**：数据修改前自动备份
- **迁移验证**：数据迁移后完整性检查
- **格式兼容**：新格式向下兼容

---

## ✅ 验收检查清单

### 功能验收
- [ ] 支持多项目并发连接
- [ ] 项目数据完全隔离
- [ ] 自动项目识别准确
- [ ] 向后兼容性完整
- [ ] 性能指标达标

### 体验验收
- [ ] 用户界面直观易用
- [ ] 项目切换流畅
- [ ] 连接状态清晰显示
- [ ] 错误提示友好
- [ ] 文档说明完整

### 稳定性验收
- [ ] 长时间运行稳定
- [ ] 异常情况处理正确
- [ ] 内存泄漏检查通过
- [ ] 并发压力测试通过
- [ ] 网络异常恢复测试通过

---

## 📋 执行建议

1. **严格按阶段执行**：每完成一个阶段进行充分测试
2. **保持功能可用**：确保每个阶段都有可工作的版本
3. **及时反馈调整**：发现问题立即调整计划
4. **文档同步更新**：代码修改和文档保持同步
5. **用户提前沟通**：重大变更提前告知用户

---

## 🚀 开始执行

选择要开始的阶段：
- [ ] 阶段 1：基础架构准备
- [ ] 阶段 2：服务端改造  
- [ ] 阶段 3：客户端改造
- [ ] 阶段 4：兼容性保证
- [ ] 阶段 5：测试与优化

**建议从阶段 1 开始，逐步推进，确保每个阶段的稳定性后再进入下一阶段。** 